# Cloud Run Service Configurations for asia-south1 (Mumbai)
# Phase 1 Deployment: Single zone (a), scale-to-zero
# Multi-zone ready: Change minInstanceCount to enable HA

---
# Service 1: www.waooaw.com - Customer Marketplace
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: waooaw-marketplace
  namespace: default
  annotations:
    run.googleapis.com/launch-stage: BETA
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        # Phase 1: Single zone, scale-to-zero
        run.googleapis.com/execution-environment: gen2
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "10"
        # Phase 2: Uncomment to enable warm instances
        # autoscaling.knative.dev/minScale: "1"
        # Phase 3: Enable multi-zone (set minScale to instances per zone)
        # run.googleapis.com/zones: asia-south1-a,asia-south1-b
    spec:
      serviceAccountName: default
      containers:
      - name: marketplace
        image: asia-south1-docker.pkg.dev/waooaw-oauth/waooaw-containers/waooaw-marketplace:latest
        ports:
        - name: http1
          containerPort: 8080
        env:
        - name: BACKEND_API_URL
          value: "https://api.waooaw.com"
        - name: OAUTH_REDIRECT
          value: "https://www.waooaw.com/auth/callback"
        resources:
          limits:
            memory: "256Mi"
            cpu: "1000m"
        startupProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 10
          failureThreshold: 3

---
# Service 2: pp.waooaw.com - Platform Portal
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: waooaw-platform-portal
  namespace: default
  annotations:
    run.googleapis.com/launch-stage: BETA
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
        autoscaling.knative.dev/minScale: "0"  # Always scale to zero (internal tool)
        autoscaling.knative.dev/maxScale: "5"
        # Single zone only for internal portals
        run.googleapis.com/zones: asia-south1-a
    spec:
      serviceAccountName: default
      containers:
      - name: platform-portal
        image: asia-south1-docker.pkg.dev/waooaw-oauth/waooaw-containers/waooaw-platform-portal:latest
        ports:
        - name: http1
          containerPort: 3000
        env:
        - name: ENV
          value: "production"
        - name: BACKEND_URL
          value: "https://api.waooaw.com"
        - name: OAUTH_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: google-client-id
              key: latest
        resources:
          limits:
            memory: "2Gi"
            cpu: "2000m"
        startupProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 0
          periodSeconds: 10
          failureThreshold: 3

---
# Service 3: dp.waooaw.com - Development Portal
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: waooaw-dev-portal
  namespace: default
  annotations:
    run.googleapis.com/launch-stage: BETA
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
        autoscaling.knative.dev/minScale: "0"  # Always scale to zero
        autoscaling.knative.dev/maxScale: "3"
        run.googleapis.com/zones: asia-south1-a
    spec:
      serviceAccountName: default
      containers:
      - name: dev-portal
        image: asia-south1-docker.pkg.dev/waooaw-oauth/waooaw-containers/waooaw-dev-portal:latest
        ports:
        - name: http1
          containerPort: 3000
        env:
        - name: ENV
          value: "production"
        - name: BACKEND_URL
          value: "https://api.waooaw.com"
        - name: PORTAL_TYPE
          value: "development"
        - name: OAUTH_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: google-client-id
              key: latest
        resources:
          limits:
            memory: "1Gi"
            cpu: "1000m"
        startupProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 0
          periodSeconds: 10
          failureThreshold: 3

---
# Service 4: yk.waooaw.com - Customer Portal
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: waooaw-customer-yk
  namespace: default
  annotations:
    run.googleapis.com/launch-stage: BETA
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "5"
        # Phase 3: Enable multi-zone if customer requires HA
        # run.googleapis.com/zones: asia-south1-a,asia-south1-b
    spec:
      serviceAccountName: default
      containers:
      - name: customer-portal
        image: asia-south1-docker.pkg.dev/waooaw-oauth/waooaw-containers/waooaw-customer-portal:latest
        ports:
        - name: http1
          containerPort: 8080
        env:
        - name: BACKEND_API_URL
          value: "https://api.waooaw.com"
        - name: CUSTOMER_ID
          value: "yk"
        - name: BRANDING_THEME
          value: "custom-yk"
        - name: OAUTH_REDIRECT
          value: "https://yk.waooaw.com/auth/callback"
        resources:
          limits:
            memory: "256Mi"
            cpu: "1000m"
        startupProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 10
          failureThreshold: 3

---
# Service 5: api.waooaw.com - Backend API
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: waooaw-api
  namespace: default
  annotations:
    run.googleapis.com/launch-stage: BETA
    run.googleapis.com/ingress: all
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
        # Phase 1: Scale to zero
        autoscaling.knative.dev/minScale: "0"
        # Phase 2: Uncomment to enable warm instance
        # autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "10"
        # Phase 3: Enable multi-zone for HA
        # run.googleapis.com/zones: asia-south1-a,asia-south1-b
        # autoscaling.knative.dev/minScale: "1"  # 1 per zone = 2 total
    spec:
      serviceAccountName: default
      containers:
      - name: api
        image: asia-south1-docker.pkg.dev/waooaw-oauth/waooaw-containers/waooaw-backend:latest
        ports:
        - name: http1
          containerPort: 8000
        env:
        - name: ENV
          value: "production"
        - name: FRONTEND_URL
          value: "https://www.waooaw.com"
        - name: GOOGLE_REDIRECT_URI
          value: "https://api.waooaw.com/auth/callback"
        - name: CORS_ORIGINS
          value: "https://www.waooaw.com,https://pp.waooaw.com,https://dp.waooaw.com,https://yk.waooaw.com"
        - name: GOOGLE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: google-client-id
              key: latest
        - name: GOOGLE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: google-client-secret
              key: latest
        resources:
          limits:
            memory: "1Gi"
            cpu: "1000m"
        startupProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 0
          periodSeconds: 10
          failureThreshold: 3
