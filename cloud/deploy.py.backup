#!/usr/bin/env python3
"""
WAOOAW Infrastructure Deployment Script
Deploys complete infrastructure using GCP Deployment Manager

Usage:
  ./deploy.py --environment demo --action create
  ./deploy.py --environment uat --action update --preview
  ./deploy.py --environment prod --action delete
"""

import argparse
import subprocess
import sys
import yaml
from pathlib import Path

# Configuration
ENVIRONMENTS = ["demo", "uat", "prod"]
ACTIONS = ["create", "update", "delete", "preview"]
PROJECT = "waooaw-oauth"
DOMAIN = "waooaw.com"

# Single static IP for ALL environments (cost savings!)
STATIC_IP_NAME = "waooaw-lb-ip"
STATIC_IP_ADDRESS = "35.190.6.91"  # Existing IP - reuse it!

# Domain configuration per environment
DOMAINS = {
    "demo": {
        "customer_portal": f"cp.demo.{DOMAIN}",
        "platform_portal": f"pp.demo.{DOMAIN}"
    },
    "uat": {
        "customer_portal": f"cp.uat.{DOMAIN}",
        "platform_portal": f"pp.uat.{DOMAIN}"
    },
    "prod": {
        "customer_portal": f"www.{DOMAIN}",  # Production uses www, not cp
        "platform_portal": f"pp.{DOMAIN}"
    }
}

# Region configuration
REGIONS = {
    "demo": ["asia-south1"],
    "uat": ["asia-south1"],
    "prod": ["asia-south1", "us-central1"]  # Multi-region for prod
}

# Scaling configuration
SCALING = {
    "demo": {
        "minInstances": 0,
        "maxInstances": 5,
        "concurrency": 80,
        "cpuThrottling": True
    },
    "uat": {
        "minInstances": 1,
        "maxInstances": 10,
        "concurrency": 80,
        "cpuThrottling": False
    },
    "prod": {
        "minInstances": 2,
        "maxInstances": 100,
        "concurrency": 80,
        "cpuThrottling": False
    }
}

def generate_config(environment, version="latest"):
    """Generate deployment configuration"""
    
    primary_region = REGIONS[environment][0]
    scaling = SCALING[environment]
    
    config = {
        "imports": [
            {"path": "templates/cloud-run.jinja"},
            {"path": "templates/load-balancer.jinja"},
            {"path": "templates/networking.jinja"}
        ],
        "resources": [
            # Networking - Static IP
            {
                "name": f"{environment}-networking",
                "type": "templates/networking.jinja",
                "properties": {
                    "environment": environment,
                    "staticIpName": f"waooaw-lb-ip-{environment}",
                    "vpcConnector": {
                        "enabled": False  # Enable when Cloud SQL is added
                    }
                }
            },
            # Backend Service
            {
                "name": f"waooaw-api-{environment}",
                "type": "templates/cloud-run.jinja",
                "properties": {
                    "name": f"waooaw-api-{environment}",
                    "environment": environment,
                    "serviceType": "backend",
                    "region": primary_region,
                    "container": {
                        "image": f"asia-south1-docker.pkg.dev/{PROJECT}/waooaw/backend-v2:{version}",
                        "port": 8000
                    },
                    "resources": {
                        "cpu": "1",
                        "memory": "512Mi"
                    },
                    "scaling": {
                        "minInstances": scaling["minInstances"],
                        "maxInstances": scaling["maxInstances"],
                        "concurrency": scaling["concurrency"],
                        "cpuThrottling": scaling["cpuThrottling"]
                    },
                    "envVars": [
                        {"name": "ENV", "value": environment},
                        {"name": "LOG_LEVEL", "value": "info"},
                        {"name": "DB_SCHEMA", "value": "public"}
                    ],
                    "secrets": [
                        {"name": "GOOGLE_CLIENT_ID", "secretName": "GOOGLE_CLIENT_ID"},
                        {"name": "GOOGLE_CLIENT_SECRET", "secretName": "GOOGLE_CLIENT_SECRET"},
                        {"name": "JWT_SECRET", "secretName": "JWT_SECRET"}
                    ],
                    "serviceAccount": f"waooaw-backend-{environment}@{PROJECT}.iam.gserviceaccount.com",
                    "executionEnvironment": "gen2",
                    "timeout": 300
                }
            },
            # Platform Portal Service
            {
                "name": f"waooaw-platform-portal-{environment}",
                "type": "templates/cloud-run.jinja",
                "properties": {
                    "name": f"waooaw-platform-portal-{environment}",
                    "environment": environment,
                    "serviceType": "platform-portal",
                    "region": primary_region,
                    "container": {
                        "image": f"asia-south1-docker.pkg.dev/{PROJECT}/waooaw/platform-portal-v2:{version}",
                        "port": 8080
                    },
                    "resources": {
                        "cpu": "1",
                        "memory": "1Gi"
                    },
                    "scaling": {
                        "minInstances": scaling["minInstances"],
                        "maxInstances": scaling["maxInstances"],
                        "concurrency": scaling["concurrency"],
                        "cpuThrottling": scaling["cpuThrottling"]
                    },
                    "envVars": [
                        {"name": "ENV", "value": environment},
                        {"name": "LOG_LEVEL", "value": "info"}
                    ],
                    "secrets": [],
                    "serviceAccount": f"waooaw-platform-{environment}@{PROJECT}.iam.gserviceaccount.com",
                    "executionEnvironment": "gen2",
                    "timeout": 300
                }
            },
            # Load Balancer
            {
                "name": f"{environment}-load-balancer",
                "type": "templates/load-balancer.jinja",
                "properties": {
                    "environment": environment,
                    "domain": DOMAIN,
                    "staticIpName": f"waooaw-lb-ip-{environment}",
                    "backends": {
                        "api": [
                            {
                                "serviceName": f"waooaw-api-{environment}",
                                "maxRate": 80,
                                "capacityScaler": 1.0
                            }
                        ],
                        "platform": [
                            {
                                "serviceName": f"waooaw-platform-portal-{environment}",
                                "maxRate": 80,
                                "capacityScaler": 1.0
                            }
                        ]
                    },
                    "healthCheck": {
                        "interval": 10,
                        "timeout": 5,
                        "healthyThreshold": 2,
                        "unhealthyThreshold": 3
                    },
                    "logSampleRate": 1.0 if environment == "demo" else 0.1
                },
                "metadata": {
                    "dependsOn": [
                        f"{environment}-networking",
                        f"waooaw-api-{environment}",
                        f"waooaw-platform-portal-{environment}"
                    ]
                }
            }
        ]
    }
    
    return config

def deploy(environment, action, preview=False, version="latest"):
    """Deploy infrastructure"""
    
    print(f"üöÄ {action.upper()} Infrastructure for {environment.upper()} environment")
    print(f"   Project: {PROJECT}")
    print(f"   Domain: {environment}.{DOMAIN}")
    print(f"   Version: {version}")
    print("=" * 80)
    
    # Generate config
    config = generate_config(environment, version)
    config_file = Path(f"/tmp/waooaw-{environment}-config.yaml")
    
    with open(config_file, 'w') as f:
        yaml.dump(config, f, default_flow_style=False)
    
    print(f"‚úÖ Generated config: {config_file}")
    
    # Build gcloud command
    deployment_name = f"waooaw-{environment}-infra"
    
    if action == "create":
        cmd = [
            "gcloud", "deployment-manager", "deployments", "create",
            deployment_name,
            "--config", str(config_file),
            "--project", PROJECT
        ]
    elif action == "update":
        cmd = [
            "gcloud", "deployment-manager", "deployments", "update",
            deployment_name,
            "--config", str(config_file),
            "--project", PROJECT
        ]
        if preview:
            cmd.append("--preview")
    elif action == "delete":
        cmd = [
            "gcloud", "deployment-manager", "deployments", "delete",
            deployment_name,
            "--project", PROJECT,
            "--quiet"
        ]
        # Confirm deletion
        confirm = input(f"‚ö†Ô∏è  Are you sure you want to DELETE {environment} infrastructure? (yes/no): ")
        if confirm.lower() != "yes":
            print("‚ùå Deletion cancelled")
            return
    
    # Execute
    print(f"\nüì¶ Executing: {' '.join(cmd)}\n")
    
    try:
        result = subprocess.run(cmd, check=True, capture_output=False, text=True)
        
        print("\n" + "=" * 80)
        print(f"‚úÖ {action.upper()} completed successfully!")
        
        if action in ["create", "update"] and not preview:
            print_post_deployment_instructions(environment)
            
    except subprocess.CalledProcessError as e:
        print(f"\n‚ùå Deployment failed: {e}")
        sys.exit(1)

def print_post_deployment_instructions(environment):
    """Print DNS and OAuth configuration instructions"""
    
    print("\n" + "=" * 80)
    print("üìã POST-DEPLOYMENT CONFIGURATION REQUIRED")
    print("=" * 80)
    
    # Get static IP
    try:
        result = subprocess.run(
            [
                "gcloud", "compute", "addresses", "describe",
                f"waooaw-lb-ip-{environment}",
                "--global",
                "--project", PROJECT,
                "--format=value(address)"
            ],
            capture_output=True,
            text=True,
            check=True
        )
        ip_address = result.stdout.strip()
    except:
        ip_address = "[CHECK GCP CONSOLE]"
    
    print(f"\n1Ô∏è‚É£  DNS Configuration (GoDaddy):")
    print(f"   ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print(f"   Type:       A")
    print(f"   Host:       {environment}")
    print(f"   Points to:  {ip_address}")
    print(f"   TTL:        600 (10 minutes)")
    
    print(f"\n2Ô∏è‚É£  Google OAuth Console:")
    print(f"   ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print(f"   URL: https://console.cloud.google.com/apis/credentials")
    print(f"   ")
    print(f"   Authorized JavaScript origins:")
    print(f"   ‚Üí https://{environment}.{DOMAIN}")
    print(f"   ")
    print(f"   Authorized redirect URIs:")
    print(f"   ‚Üí https://{environment}.{DOMAIN}/api/auth/callback")
    
    print(f"\n3Ô∏è‚É£  Access URLs:")
    print(f"   ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print(f"   Platform Portal: https://{environment}.{DOMAIN}")
    print(f"   Backend API:     https://{environment}.{DOMAIN}/api")
    print(f"   Health Check:    https://{environment}.{DOMAIN}/api/health")
    
    print(f"\n4Ô∏è‚É£  Verification:")
    print(f"   ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print(f"   # Check SSL certificate status (wait 10-15 mins after DNS)")
    print(f"   gcloud compute ssl-certificates describe {environment}-ssl-cert --global --project={PROJECT}")
    print(f"   ")
    print(f"   # Test endpoints")
    print(f"   curl https://{environment}.{DOMAIN}/api/health")
    print(f"   ")
    print(f"   # View logs")
    print(f"   gcloud logging read 'resource.type=cloud_run_revision AND resource.labels.service_name=waooaw-api-{environment}' --limit=20 --project={PROJECT}")
    
    print("\n" + "=" * 80)

def main():
    parser = argparse.ArgumentParser(
        description="Deploy WAOOAW infrastructure to GCP",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument(
        "--environment", "-e",
        required=True,
        choices=ENVIRONMENTS,
        help="Environment to deploy (demo, uat, prod)"
    )
    
    parser.add_argument(
        "--action", "-a",
        required=True,
        choices=ACTIONS,
        help="Action to perform (create, update, delete, preview)"
    )
    
    parser.add_argument(
        "--version", "-v",
        default="latest",
        help="Docker image version tag (default: latest)"
    )
    
    parser.add_argument(
        "--preview",
        action="store_true",
        help="Preview changes without applying (for update action)"
    )
    
    args = parser.parse_args()
    
    deploy(args.environment, args.action, args.preview, args.version)

if __name__ == "__main__":
    main()
