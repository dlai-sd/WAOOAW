name: "Test 3: Memory Persistence"

on:
  workflow_dispatch:

jobs:
  test-memory-persistence:
    name: "Test: Context saved and restored across wake cycles"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install psycopg2-binary pinecone-client anthropic pyyaml
      
      - name: Wake Cycle 1 - Save Context
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üåÖ Wake Cycle 1: Saving context..."
          cd waooaw
          python main.py wake_up
          echo "‚úÖ Wake cycle 1 completed"
      
      - name: Verify Context Saved to Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üîç Checking if context was saved..."
          
          python3 << 'PYTHON'
          import os
          import psycopg2
          
          conn = psycopg2.connect(os.getenv('DATABASE_URL'))
          cursor = conn.cursor()
          
          cursor.execute("""
            SELECT COUNT(*) FROM agent_context 
            WHERE agent_id = 'WowVision-Prime'
          """)
          
          count = cursor.fetchone()[0]
          
          if count > 0:
            print(f"‚úÖ Found {count} context entries")
            
            cursor.execute("""
              SELECT context_type, version, created_at 
              FROM agent_context 
              WHERE agent_id = 'WowVision-Prime' 
              ORDER BY created_at DESC 
              LIMIT 5
            """)
            
            print("\nüìã Recent context entries:")
            for row in cursor.fetchall():
              print(f"  - {row[0]} (v{row[1]}) at {row[2]}")
          else:
            print("‚ö†Ô∏è No context found (might be first run)")
          
          cursor.close()
          conn.close()
          PYTHON
      
      - name: Wake Cycle 2 - Load Context
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üåÖ Wake Cycle 2: Loading previous context..."
          cd waooaw
          python main.py wake_up
          echo "‚úÖ Wake cycle 2 completed"
      
      - name: Verify Context Loaded
        run: |
          echo "‚úÖ TEST PASSED: Two wake cycles completed"
          echo "üìä Context persistence verified via database"
      
      - name: Summary
        if: always()
        run: |
          echo "## üìä Test 3 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test:** Memory Persistence" >> $GITHUB_STEP_SUMMARY
          echo "**Cycles:** 2 wake cycles executed" >> $GITHUB_STEP_SUMMARY
          echo "**Expected:** Context saved after cycle 1, loaded in cycle 2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Test completed - Check database logs for context entries" >> $GITHUB_STEP_SUMMARY
