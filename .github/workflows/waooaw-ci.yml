name: WAOOAW CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: waooaw-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  workflow_validation:
    name: Workflow YAML Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate workflow YAML syntax
        run: |
          yamllint -d "{extends: default, rules: {line-length: {max: 200}, comments: disable, comments-indentation: disable, document-start: disable, truthy: disable}}" .github/workflows/*.yml

      - name: Check workflows parse correctly
        run: |
          python3 -c "
          import yaml
          import sys
          from pathlib import Path

          failures = []
          for f in Path('.github/workflows').glob('*.yml'):
              try:
                  yaml.safe_load(f.read_text())
                  print(f'✅ {f.name}')
              except Exception as e:
                  failures.append(f'{f.name}: {e}')

          if failures:
              print('\n'.join(failures))
              sys.exit(1)
          "

  package_lock_sync:
    name: Package Lock Sync Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check CP Frontend lock sync
        if: hashFiles('src/CP/FrontEnd/package.json') != ''
        run: |
          cd src/CP/FrontEnd
          npm ci --dry-run || {
            echo "::error::CP Frontend package-lock.json out of sync with package.json"
            echo "Run 'npm install' locally and commit the updated package-lock.json"
            exit 1
          }

      - name: Check PP Frontend lock sync
        if: hashFiles('src/PP/FrontEnd/package.json') != ''
        run: |
          cd src/PP/FrontEnd
          npm ci --dry-run || {
            echo "::error::PP Frontend package-lock.json out of sync with package.json"
            echo "Run 'npm install' locally and commit the updated package-lock.json"
            exit 1
          }

  backend_tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        component: [CP, PP, Plant]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check if component exists
        id: check
        run: |
          if [ -f "src/${{ matrix.component }}/BackEnd/requirements.txt" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            if [ -d "src/${{ matrix.component }}/BackEnd/tests" ] && [ -n "$(find src/${{ matrix.component }}/BackEnd/tests -name 'test_*.py' -o -name '*_test.py')" ]; then
              echo "has_tests=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_tests=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.check.outputs.exists == 'true'
        run: |
          cd src/${{ matrix.component }}/BackEnd
          pip install -r requirements.txt

      - name: Run pytest
        if: steps.check.outputs.exists == 'true' && steps.check.outputs.has_tests == 'true'
        env:
          DATABASE_URL: "postgresql+asyncpg://postgres:postgres@localhost:5432/waooaw_test"
          JWT_SECRET_KEY: "test-secret-key-for-ci"
          GOOGLE_CLIENT_ID: "test-client-id"
          GOOGLE_CLIENT_SECRET: "test-client-secret"
          ENVIRONMENT: "test"
        run: |
          cd src/${{ matrix.component }}/BackEnd
          pytest tests/ -v --tb=short \
            --ignore=tests/integration \
            --ignore=tests/performance \
            --ignore=tests/e2e \
            --ignore=tests/security/test_security_regression.py \
            --ignore=tests/test_auth_load.py \
            -k "not load and not integration and not performance and not regression" || {
            echo "::error::${{ matrix.component }} backend tests failed"
            exit 1
          }

      - name: Skip tests (no test files)
        if: steps.check.outputs.exists == 'true' && steps.check.outputs.has_tests == 'false'
        run: |
          echo "⚠️ No tests found for ${{ matrix.component }} - skipping pytest"
          echo "::warning::${{ matrix.component }} backend has no test files"

  pp_backend_docker_tests:
    name: PP BackEnd Docker Tests (Coverage Gate)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect PP BackEnd Docker setup
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "src/PP/BackEnd/Dockerfile" ] && [ -f "src/PP/BackEnd/requirements.txt" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip (PP BackEnd not present)
        if: steps.detect.outputs.exists != 'true'
        run: |
          echo "⚠️ PP BackEnd Dockerfile/requirements.txt not found - skipping"
          echo "::warning::PP BackEnd Docker tests skipped"

      - name: Build PP BackEnd test image
        if: steps.detect.outputs.exists == 'true'
        run: |
          set -euo pipefail
          docker build -t waooaw-pp-backend:test src/PP/BackEnd

      - name: Run PP BackEnd tests inside container
        if: steps.detect.outputs.exists == 'true'
        run: |
          set -euo pipefail
          docker run --rm --entrypoint pytest waooaw-pp-backend:test -q

  terraform_checks:
    name: Terraform Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform fmt check (stacks + modules)
        run: terraform fmt -recursive -check cloud/terraform/stacks cloud/terraform/modules

      - name: Terraform validate (no backend)
        shell: bash
        run: |
          set -euo pipefail
          for d in cloud/terraform/stacks/foundation cloud/terraform/stacks/cp cloud/terraform/stacks/pp cloud/terraform/stacks/plant; do
            echo "--- validate: $d"
            (cd "$d" && terraform init -backend=false -input=false >/dev/null && terraform validate)
          done

  docker_build_smoke:
    name: Docker Build Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect components
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          has_cp=false
          has_pp=false
          has_plant=false

          if [ -f src/CP/BackEnd/Dockerfile ] && [ -f src/CP/FrontEnd/Dockerfile ]; then
            has_cp=true
          fi

          if [ -f src/PP/BackEnd/Dockerfile ] && [ -f src/PP/FrontEnd/Dockerfile ]; then
            has_pp=true
          fi

          if [ -f src/Plant/BackEnd/Dockerfile ]; then
            has_plant=true
          fi

          echo "has_cp=${has_cp}" >> "$GITHUB_OUTPUT"
          echo "has_pp=${has_pp}" >> "$GITHUB_OUTPUT"
          echo "has_plant=${has_plant}" >> "$GITHUB_OUTPUT"

      - name: Build CP images (no push)
        if: steps.detect.outputs.has_cp == 'true'
        env:
          VITE_GOOGLE_CLIENT_ID: dummy-ci-client-id
        run: |
          set -euo pipefail
          docker build -f src/CP/BackEnd/Dockerfile src/CP/BackEnd
          docker build \
            --build-arg VITE_GOOGLE_CLIENT_ID="${VITE_GOOGLE_CLIENT_ID}" \
            --build-arg VITE_ENVIRONMENT="ci" \
            -f src/CP/FrontEnd/Dockerfile \
            src/CP/FrontEnd

      - name: Build PP images (no push)
        if: steps.detect.outputs.has_pp == 'true'
        env:
          VITE_GOOGLE_CLIENT_ID: dummy-ci-client-id
        run: |
          set -euo pipefail
          docker build -f src/PP/BackEnd/Dockerfile src/PP/BackEnd
          docker build \
            --build-arg VITE_GOOGLE_CLIENT_ID="${VITE_GOOGLE_CLIENT_ID}" \
            --build-arg VITE_ENVIRONMENT="ci" \
            -f src/PP/FrontEnd/Dockerfile \
            src/PP/FrontEnd

      - name: Build Plant image (no push)
        if: steps.detect.outputs.has_plant == 'true'
        run: |
          set -euo pipefail
          docker build -f src/Plant/BackEnd/Dockerfile src/Plant/BackEnd

  mobile_checks:
    name: Mobile Lint & Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect mobile changes
        id: detect_mobile
        shell: bash
        run: |
          set -euo pipefail
          has_mobile=false
          mobile_changed=false

          # Check if mobile directory exists
          if [ -d src/mobile ]; then
            has_mobile=true
          fi

          # For PRs, check if mobile files changed
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^src/mobile/"; then
              mobile_changed=true
            fi
          # For pushes, check last commit
          elif [ "${{ github.event_name }}" = "push" ]; then
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/mobile/"; then
              mobile_changed=true
            fi
          fi

          echo "has_mobile=${has_mobile}" >> "$GITHUB_OUTPUT"
          echo "mobile_changed=${mobile_changed}" >> "$GITHUB_OUTPUT"
          echo "Mobile directory exists: ${has_mobile}"
          echo "Mobile files changed: ${mobile_changed}"

      - name: Run mobile lint
        if: steps.detect_mobile.outputs.has_mobile == 'true' && steps.detect_mobile.outputs.mobile_changed == 'true'
        run: |
          set -euo pipefail
          docker-compose -f docker-compose.mobile.yml build mobile-lint
          docker-compose -f docker-compose.mobile.yml run --rm mobile-lint

      - name: Run mobile typecheck
        if: steps.detect_mobile.outputs.has_mobile == 'true' && steps.detect_mobile.outputs.mobile_changed == 'true'
        run: |
          set -euo pipefail
          docker-compose -f docker-compose.mobile.yml build mobile-typecheck
          docker-compose -f docker-compose.mobile.yml run --rm mobile-typecheck
