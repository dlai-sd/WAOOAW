name: Plant SDK Generation

on:
  push:
    paths:
      - 'src/Plant/BackEnd/**'
      - 'src/Plant/Gateway/**'
      - 'scripts/sdk/**'
      - '.github/workflows/plant-sdk-generate.yml'
  pull_request:
    paths:
      - 'src/Plant/BackEnd/**'
      - 'src/Plant/Gateway/**'
      - 'scripts/sdk/**'
      - '.github/workflows/plant-sdk-generate.yml'

jobs:
  generate-sdks:
    runs-on: ubuntu-latest
    env:
      GATEWAY_OPENAPI_URL: http://localhost:8000/api/openapi.json
    steps:
      - uses: actions/checkout@v4

      - name: Start Plant Gateway (docker compose)
        run: |
          docker compose -f docker-compose.local.yml up -d postgres redis plant-backend plant-gateway

      - name: Wait for Gateway health
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8000/health > /dev/null; then
              echo "Gateway healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Gateway health check timed out" >&2
          docker compose -f docker-compose.local.yml ps
          exit 1

      - name: Generate SDKs
        run: |
          bash scripts/sdk/generate_plant_sdks.sh

      - name: Validate Python SDK (compile)
        run: |
          docker run --rm -v "$PWD/.generated/plant-sdk/python:/app" -w /app python:3.11-slim \
            python -m compileall .

      - name: Validate JS SDK (pack dry-run)
        run: |
          docker run --rm -v "$PWD/.generated/plant-sdk/js:/app" -w /app node:20-bullseye bash -lc \
            "npm install --no-audit --no-fund && npm pack --dry-run"

      - name: Upload generated SDK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plant-sdks
          path: .generated/plant-sdk

      # Optional publishing (requires secrets, no-op otherwise)
      - name: Publish JS SDK (internal npm)
        if: ${{ secrets.NPM_REGISTRY_URL != '' && secrets.NPM_TOKEN != '' && github.ref == 'refs/heads/main' }}
        env:
          NPM_REGISTRY_URL: ${{ secrets.NPM_REGISTRY_URL }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cat > .generated/plant-sdk/js/.npmrc << 'EOF'
          //${NPM_REGISTRY_URL#https://}/:_authToken=${NPM_TOKEN}
          registry=${NPM_REGISTRY_URL}
          always-auth=true
          EOF
          docker run --rm \
            -v "$PWD/.generated/plant-sdk/js:/app" \
            -w /app \
            -e NPM_CONFIG_USERCONFIG=/app/.npmrc \
            node:20-bullseye bash -lc "npm publish --registry $NPM_REGISTRY_URL"

      - name: Publish Python SDK (internal PyPI)
        if: ${{ secrets.PYPI_REPOSITORY_URL != '' && secrets.PYPI_USERNAME != '' && secrets.PYPI_PASSWORD != '' && github.ref == 'refs/heads/main' }}
        env:
          PYPI_REPOSITORY_URL: ${{ secrets.PYPI_REPOSITORY_URL }}
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          docker run --rm \
            -v "$PWD/.generated/plant-sdk/python:/app" \
            -w /app \
            -e TWINE_REPOSITORY_URL="$PYPI_REPOSITORY_URL" \
            -e TWINE_USERNAME="$PYPI_USERNAME" \
            -e TWINE_PASSWORD="$PYPI_PASSWORD" \
            python:3.11-slim bash -lc \
            "pip install --no-cache-dir build twine && python -m build && twine upload dist/*"