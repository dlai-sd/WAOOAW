name: Mobile Google Play Store Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - demo
          - production
      track:
        description: 'Play Store track'
        required: true
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: 'Bug fixes and performance improvements'

permissions:
  contents: write
  id-token: write

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      version: ${{ steps.config.outputs.version }}
      track: ${{ steps.config.outputs.track }}
      build-profile: ${{ steps.config.outputs.build-profile }}
      is-production: ${{ steps.config.outputs.is-production }}

    steps:
      - name: Determine deployment configuration
        id: config
        run: |
          # Manual dispatch takes precedence
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "track=${{ github.event.inputs.track }}" >> $GITHUB_OUTPUT
            echo "version=manual-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "build-profile=${{ github.event.inputs.environment }}-store" >> $GITHUB_OUTPUT
            echo "is-production=${{ github.event.inputs.environment == 'production' }}" >> $GITHUB_OUTPUT

          # Push to fix branch - use demo environment
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "environment=demo" >> $GITHUB_OUTPUT
            echo "track=internal" >> $GITHUB_OUTPUT
            echo "version=auto-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "build-profile=demo-store" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT

          # Tag-based deployment
          elif [[ "${{ github.ref }}" =~ mobile-playstore-v([0-9]+\.[0-9]+\.[0-9]+)-demo\. ]]; then
            echo "environment=demo" >> $GITHUB_OUTPUT
            echo "track=internal" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "build-profile=demo-store" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT

          elif [[ "${{ github.ref }}" =~ mobile-playstore-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "track=production" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "build-profile=production" >> $GITHUB_OUTPUT
            echo "is-production=true" >> $GITHUB_OUTPUT

          else
            echo "âŒ Invalid trigger. Use workflow_dispatch or tag format: mobile-playstore-v1.2.3"
            exit 1
          fi

      - name: Display configuration
        run: |
          echo "ðŸš€ Deployment Configuration:"
          echo "  Environment: ${{ steps.config.outputs.environment }}"
          echo "  Version: ${{ steps.config.outputs.version }}"
          echo "  Track: ${{ steps.config.outputs.track }}"
          echo "  Build Profile: ${{ steps.config.outputs.build-profile }}"
          echo "  Is Production: ${{ steps.config.outputs.is-production }}"

  lint-and-test:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/mobile/package-lock.json

      - name: Install dependencies
        working-directory: src/mobile
        run: npm ci

      - name: Preflight versioning guard
        working-directory: src/mobile
        run: |
          set -euo pipefail

          echo "ðŸ”Ž Preflight: validating committed versioning configuration"
          echo "  Expected SHA: ${{ github.sha }}"
          echo "  Checked out SHA: $(git rev-parse HEAD)"
          echo "  Build profile: ${{ needs.prepare.outputs.build-profile }}"

          APP_VERSION_CODE=$(jq -r '.expo.android.versionCode // empty' app.json)
          APP_VERSION_SOURCE=$(jq -r '.cli.appVersionSource // "local"' eas.json)
          PROFILE_AUTO_INCREMENT=$(jq -r '.build["${{ needs.prepare.outputs.build-profile }}"].android.autoIncrement // empty' eas.json)

          if [[ -z "$APP_VERSION_CODE" || ! "$APP_VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "âŒ Invalid app.json android.versionCode: '$APP_VERSION_CODE'"
            exit 1
          fi

          if [[ "$APP_VERSION_SOURCE" != "remote" ]]; then
            echo "âŒ eas.json cli.appVersionSource must be 'remote' but is '$APP_VERSION_SOURCE'"
            echo "   Fix by committing src/mobile/eas.json with appVersionSource=remote before rerun."
            exit 1
          fi

          if [[ "$PROFILE_AUTO_INCREMENT" != "versionCode" ]]; then
            echo "âŒ eas.json build profile '${{ needs.prepare.outputs.build-profile }}' android.autoIncrement must be 'versionCode' but is '$PROFILE_AUTO_INCREMENT'"
            exit 1
          fi

          echo "âœ… Preflight passed"
          echo "  app.json android.versionCode: $APP_VERSION_CODE"
          echo "  eas.json cli.appVersionSource: $APP_VERSION_SOURCE"
          echo "  profile android.autoIncrement: $PROFILE_AUTO_INCREMENT"

      - name: Verify checked-out commit and plugin config
        working-directory: src/mobile
        run: |
          echo "ðŸ”Ž Checked out SHA: ${{ github.sha }}"
          git rev-parse HEAD
          echo "ðŸ”Ž expo-font plugin entries in app.json:"
          jq -r '.expo.plugins // []' app.json

      - name: Run linter
        working-directory: src/mobile
        env:
          ESLINT_USE_FLAT_CONFIG: false
        run: npm run lint || echo "âš ï¸ Lint warnings found but not blocking deployment"
        continue-on-error: true

      - name: Run type check
        working-directory: src/mobile
        run: npm run typecheck || echo "âš ï¸ Type check warnings found but not blocking deployment"
        continue-on-error: true

      - name: Run tests
        working-directory: src/mobile
        run: npm test -- --ci --maxWorkers=2 || echo "âš ï¸ Test failures found but not blocking deployment"
        continue-on-error: true

  build-and-submit:
    name: Build & Submit to Play Store
    runs-on: ubuntu-latest
    needs: [prepare, lint-and-test]
    environment:
      name: mobile-${{ needs.prepare.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: src/mobile
        run: npm ci

      - name: Update app version
        working-directory: src/mobile
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ðŸ“¦ Updating version to $VERSION"

          # Update version in app.json
          jq ".expo.version = \"$VERSION\"" app.json > app.json.tmp
          mv app.json.tmp app.json

          # Display updated version
          echo "âœ… Version updated:"
          jq '.expo.version' app.json

      - name: Setup Google Play service account
        working-directory: src/mobile
        run: |
          echo "ðŸ”‘ Setting up Google Play service account..."
          mkdir -p secrets
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > secrets/google-play-service-account.json
          chmod 600 secrets/google-play-service-account.json
          echo "âœ… Service account configured"

      - name: Build Android App Bundle (AAB)
        working-directory: src/mobile
        run: |
          echo "ðŸ—ï¸ Building Android App Bundle..."
          echo "  Profile: ${{ needs.prepare.outputs.build-profile }}"
          echo "  Platform: android"

          # Submit build and capture exact build ID for this run
          # EAS may occasionally return non-zero even after queueing a build.
          set +e
          BUILD_OUTPUT=$(eas build \
            --profile ${{ needs.prepare.outputs.build-profile }} \
            --platform android \
            --json \
            --non-interactive \
            --no-wait 2>&1)
          EAS_EXIT_CODE=$?
          set -e

          echo "$BUILD_OUTPUT"

          # Extract build ID from JSON output (supports both object and array output)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r 'if type=="array" then .[0].id // empty else .id // empty end' 2>/dev/null)

          if [ -z "$BUILD_ID" ]; then
            echo "âŒ Could not extract build ID from EAS output"
            echo "âŒ EAS exit code: $EAS_EXIT_CODE"
            exit 1
          else
            echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
            echo "âœ… Build ID: $BUILD_ID"
            if [ "$EAS_EXIT_CODE" -ne 0 ]; then
              echo "âš ï¸ EAS returned exit code $EAS_EXIT_CODE but build was queued successfully. Continuing with BUILD_ID monitoring."
            fi
          fi

          echo "âœ… Build submitted to EAS successfully!"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Wait for build completion
        working-directory: src/mobile
        run: |
          echo "â³ Waiting for build to complete (~5-7 minutes, max 30 min)..."

          if [ -z "${BUILD_ID:-}" ]; then
            echo "âŒ BUILD_ID is missing; cannot monitor build"
            exit 1
          fi
          
          MAX_WAIT=1800
          ELAPSED=0
          SLEEP_INTERVAL=30

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            BUILD_INFO=$(eas build:view "$BUILD_ID" --json --non-interactive 2>&1 || echo "{}")

            if echo "$BUILD_INFO" | jq empty 2>/dev/null; then
              BUILD_STATUS=$(echo "$BUILD_INFO" | jq -r '.status // "unknown"' | tr '[:upper:]' '[:lower:]')

              echo "â³ Build $BUILD_ID status: $BUILD_STATUS (${ELAPSED}s elapsed)"

              if [ "$BUILD_STATUS" == "finished" ]; then
                echo "âœ… Build completed successfully!"
                break
              elif [ "$BUILD_STATUS" == "errored" ]; then
                echo "âŒ Build failed!"
                exit 1
              elif [ "$BUILD_STATUS" == "canceled" ]; then
                echo "âŒ Build was canceled!"
                exit 1
              fi
            else
              echo "â³ Waiting for build status to be available... (${ELAPSED}s elapsed)"
            fi
            
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Build timed out after ${MAX_WAIT} seconds"
            exit 1
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download AAB from EAS
        working-directory: src/mobile
        run: |
          echo "ðŸ“¥ Downloading AAB from EAS..."
          
          if [ -z "${BUILD_ID:-}" ]; then
            echo "âŒ BUILD_ID is missing; cannot download AAB"
            exit 1
          fi

          BUILD_INFO=$(eas build:view "$BUILD_ID" --json --non-interactive)
          AAB_URL=$(echo "$BUILD_INFO" | jq -r '.artifacts.buildUrl // empty')

          if [ -z "$AAB_URL" ]; then
            echo "âŒ Could not extract AAB URL from build"
            echo "Build info: $BUILD_INFO"
            exit 1
          fi

          echo "Downloading from: $AAB_URL"
          curl -L -o app-release.aab "$AAB_URL"
          
          if [ ! -f app-release.aab ]; then
            echo "âŒ Failed to download AAB"
            exit 1
          fi

          FILE_SIZE=$(du -h app-release.aab | cut -f1)
          echo "âœ… AAB downloaded successfully ($FILE_SIZE)"
          echo "AAB_PATH=$(pwd)/app-release.aab" >> $GITHUB_ENV
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Setup Google Cloud SDK
        if: env.GCP_SA_KEY != '' && env.GCP_PROJECT_ID != ''
        uses: google-github-actions/setup-gcloud@v1
        with:
          version: latest
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Run Firebase Test Lab (Robo Test)
        if: env.GCP_SA_KEY != '' && env.GCP_PROJECT_ID != ''
        run: |
          echo "ðŸš€ Running Firebase Test Lab Robo Test..."
          echo "  Build ID: ${BUILD_ID}"
          echo "  AAB: ${AAB_PATH}"
          echo "  Environment: ${{ needs.prepare.outputs.environment }}"

          if [ -z "${AAB_PATH:-}" ]; then
            echo "âŒ AAB_PATH is not set"
            exit 1
          fi

          # Run robo test on physical devices
          gcloud firebase test android run \
            --type robo \
            --app "${AAB_PATH}" \
            --device model=oriole,version=34,locale=en,orientation=portrait \
            --device model=redfin,version=33,locale=en,orientation=portrait \
            --timeout 15m \
            --results-bucket "gs://${{ secrets.GCP_PROJECT_ID }}-test-results" \
            --results-dir "mobile-playstore-${{ github.run_id }}" \
            || {
              echo "âš ï¸ Firebase Test Lab failed. Checking if it's a non-critical failure..."
              exit 0
            }

          echo "âœ… Firebase Test Lab Robo Test completed!"
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

      - name: Fetch and Display Test Results
        if: env.GCP_SA_KEY != '' && env.GCP_PROJECT_ID != ''
        continue-on-error: true
        run: |
          echo "ðŸ“Š Fetching Firebase Test Lab results..."
          
          RESULTS_DIR="gs://${{ secrets.GCP_PROJECT_ID }}-test-results/mobile-playstore-${{ github.run_id }}"
          echo "Results stored at: $RESULTS_DIR"
          
          # List test results
          gsutil -m ls -r "$RESULTS_DIR" || echo "âš ï¸ Could not fetch results (may not be available yet)"
          
          echo "ðŸ“‹ Test results can be viewed in Firebase Console:"
          echo "  https://console.firebase.google.com/project/${{ secrets.GCP_PROJECT_ID }}/testlab"
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

      - name: Submit to Google Play Store (Auto)
        working-directory: src/mobile
        run: |
          echo "ðŸ“¤ Submitting to Google Play Store..."
          echo "  Track: ${{ needs.prepare.outputs.track }}"
          echo "  Service Account: Using file at ./secrets/google-play-service-account.json"
          echo "  Build ID: ${BUILD_ID:-missing}"

          if [ -z "${BUILD_ID:-}" ]; then
            echo "âŒ BUILD_ID is missing; refusing to submit unknown latest build"
            exit 1
          fi

          # Submit exact build from this workflow run
          eas submit \
            --platform android \
            --profile ${{ needs.prepare.outputs.environment }} \
            --id "$BUILD_ID" \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Cleanup secrets
        if: always()
        run: |
          rm -f src/mobile/secrets/google-play-service-account.json
          echo "ðŸ§¹ Cleaned up secrets"

      - name: Create release notes
        id: release-notes
        run: |
          NOTES="${{ github.event.inputs.release_notes || 'Bug fixes and performance improvements' }}"
          ENV="${{ needs.prepare.outputs.environment }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          TRACK="${{ needs.prepare.outputs.track }}"

          cat > release_notes.md << EOF
          # WAOOAW Mobile - $ENV Release

          **Version**: $VERSION
          **Track**: $TRACK
          **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Release Notes

          $NOTES

          ## Configuration
          - **Environment**: $ENV
          - **Backend**: ${{ needs.prepare.outputs.environment == 'demo' && 'https://waooaw-api-demo-ryvhxvrdna-el.a.run.app' || 'https://api.waooaw.com' }}
          - **Build Profile**: ${{ needs.prepare.outputs.build-profile }}
          - **Distribution**: Google Play Store ($TRACK track)

          ## Links
          - [Play Console](https://play.google.com/console)
          - [EAS Builds](https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds)

          ## Next Steps
          1. Monitor crash reports in Play Console
          2. Check user reviews
          3. Monitor backend metrics
          4. Plan next release
          EOF

          cat release_notes.md

      - name: Create GitHub Release
        if: needs.prepare.outputs.is-production == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Mobile v${{ needs.prepare.outputs.version }} - Play Store
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playstore-deployment-${{ needs.prepare.outputs.version }}
          path: |
            release_notes.md
            src/mobile/app.json
          retention-days: 90

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [prepare, build-and-submit]
    if: always()

    steps:
      - name: Notify Slack
        if: always() && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ *Google Play Store Deployment*

            *Status*: ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}
            *Environment*: ${{ needs.prepare.outputs.environment }}
            *Version*: ${{ needs.prepare.outputs.version }}
            *Track*: ${{ needs.prepare.outputs.track }}

            *Links*:
            â€¢ <https://play.google.com/console|Play Console>
            â€¢ <https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds|EAS Builds>
            â€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.SLACK_WEBHOOK }}

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            const body = `${status} **Google Play Store Deployment**

            - **Environment**: ${{ needs.prepare.outputs.environment }}
            - **Version**: ${{ needs.prepare.outputs.version }}
            - **Track**: ${{ needs.prepare.outputs.track }}
            - **Status**: ${{ job.status }}

            [View in Play Console](https://play.google.com/console) | [View Build](https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds)`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  rollback-plan:
    name: Prepare Rollback Plan
    runs-on: ubuntu-latest
    needs: [prepare, build-and-submit]
    if: failure() && needs.prepare.outputs.is-production == 'true'

    steps:
      - name: Create rollback instructions
        run: |
          cat > rollback_plan.md << 'EOF'
          # ðŸš¨ Rollback Plan - Production Deployment Failed

          ## Immediate Actions

          1. **Halt rollout in Play Console**:
             ```
             - Go to: https://play.google.com/console
             - Navigate to: Release > Production
             - Click "Halt rollout" on the latest release
             ```

          2. **Revert to previous version**:
             ```bash
             cd /workspaces/WAOOAW/src/mobile

             # Find previous successful build
             eas build:list --platform android --status finished --limit 5

             # Submit previous build
             eas submit --platform android --id <PREVIOUS_BUILD_ID>
             ```

          3. **Notify users** (if already rolled out):
             - Post in app notification
             - Email to affected users
             - Status page update

          ## Investigation

          1. Check EAS build logs: https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds
          2. Check Play Console crash reports
          3. Review backend logs for API errors
          4. Check GitHub Actions logs

          ## Prevention

          - Run full test suite before production deployment
          - Use internal track for initial testing
          - Gradual rollout (10% â†’ 50% â†’ 100%)
          - Monitor crash-free rate in first 24 hours

          EOF

          cat rollback_plan.md

      - name: Upload rollback plan
        uses: actions/upload-artifact@v4
        with:
          name: rollback-plan-${{ github.run_id }}
          path: rollback_plan.md
          retention-days: 30

      - name: Alert team
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš¨ *PRODUCTION DEPLOYMENT FAILED* ðŸš¨",
              attachments: [{
                color: 'danger',
                text: "Mobile app deployment to production Play Store failed. Rollback plan generated.",
                fields: [
                  { title: "Version", value: "${{ needs.prepare.outputs.version }}", short: true },
                  { title: "Track", value: "${{ needs.prepare.outputs.track }}", short: true }
                ],
                actions: [{
                  type: "button",
                  text: "View Logs",
                  url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.SLACK_WEBHOOK }}
