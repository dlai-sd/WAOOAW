name: Deploy to Demo Environment

on:
  push:
    branches:
      - 'feature/**'
      - 'feat/**'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: waooaw-oauth
  GCP_REGION: asia-south1
  ENVIRONMENT: demo
  
jobs:
  deploy-backend:
    name: Deploy Backend API to Demo
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build Backend Docker image
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/backend-demo:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/backend-demo:latest \
            -f backend-v2/Dockerfile backend-v2/
      
      - name: Push Backend image to Artifact Registry
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/backend-demo:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/backend-demo:latest
      
      - name: Deploy Backend to Cloud Run
        run: |
          gcloud run deploy waooaw-api-demo \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/backend-demo:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 8000 \
            --set-env-vars "ENV=demo,USE_DATABASE=false" \
            --set-secrets "JWT_SECRET=JWT_SECRET:latest,GOOGLE_CLIENT_ID=GOOGLE_CLIENT_ID:latest,GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest"
      
      - name: Backend Smoke Test
        run: |
          BACKEND_URL=$(gcloud run services describe waooaw-api-demo --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "Backend URL: $BACKEND_URL"
          
          # Wait for service to be ready
          sleep 10
          
          # Test health endpoint
          curl -f "$BACKEND_URL/health" || exit 1
          echo "‚úÖ Backend health check passed"

  deploy-platform-portal:
    name: Deploy Platform Portal to Demo
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build Platform Portal Docker image
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/platform-portal-demo:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/platform-portal-demo:latest \
            -f PlatformPortal-v2/Dockerfile PlatformPortal-v2/
      
      - name: Push Platform Portal image to Artifact Registry
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/platform-portal-demo:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/platform-portal-demo:latest
      
      - name: Deploy Platform Portal to Cloud Run
        run: |
          gcloud run deploy waooaw-platform-portal-demo \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/platform-portal-demo:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 8080 \
            --timeout 60 \
            --set-env-vars "ENV=demo,BACKEND_URL=https://demo-api.waooaw.com"
      
      - name: Platform Portal Smoke Test
        run: |
          PORTAL_URL=$(gcloud run services describe waooaw-platform-portal-demo --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "Platform Portal URL: $PORTAL_URL"
          
          # Retry logic for cold start (Reflex compilation takes time)
          MAX_RETRIES=6
          RETRY_DELAY=5
          
          echo "Waiting for Platform Portal to be ready (cold start may take 30s+)..."
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            
            # Test root path
            if curl -f -s "$PORTAL_URL/" > /dev/null 2>&1; then
              echo "‚úÖ Frontend responding"
              
              # Test backend ping
              if curl -f -s "$PORTAL_URL/ping" > /dev/null 2>&1; then
                echo "‚úÖ Backend API responding"
                echo "‚úÖ Platform Portal health check passed!"
                exit 0
              else
                echo "‚ö†Ô∏è  Backend not ready yet..."
              fi
            else
              echo "‚ö†Ô∏è  Frontend not ready yet..."
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "‚ùå Platform Portal failed to respond after $((MAX_RETRIES * RETRY_DELAY))s"
          exit 1

  deploy-waooaw-portal:
    name: Deploy WaooawPortal to Demo
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build WaooawPortal Docker image
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/waooaw-portal-demo:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/waooaw-portal-demo:latest \
            -f WaooawPortal-v2/Dockerfile WaooawPortal-v2/
      
      - name: Push WaooawPortal image to Artifact Registry
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/waooaw-portal-demo:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/waooaw-portal-demo:latest
      
      - name: Deploy WaooawPortal to Cloud Run
        run: |
          gcloud run deploy waooaw-portal-demo \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/waooaw/waooaw-portal-demo:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 256Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --port 80
      
      - name: WaooawPortal Smoke Test
        run: |
          PORTAL_URL=$(gcloud run services describe waooaw-portal-demo --region ${{ env.GCP_REGION }} --format 'value(status.url)')
          echo "WaooawPortal URL: $PORTAL_URL"
          
          # Retry logic for cold start
          MAX_RETRIES=5
          RETRY_DELAY=3
          
          echo "Waiting for WaooawPortal to be ready..."
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            if curl -f -s "$PORTAL_URL/" > /dev/null 2>&1; then
              echo "‚úÖ WaooawPortal health check passed!"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              sleep $RETRY_DELAY
            fi
          done
          
          echo "‚ùå WaooawPortal failed to respond"
          exit 1

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-platform-portal, deploy-waooaw-portal]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "üöÄ Demo Environment Deployment Complete!"
          echo "Backend: https://demo-api.waooaw.com"
          echo "Platform Portal: https://demo-pp.waooaw.com"
          echo "WaooawPortal: https://demo-www.waooaw.com"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
