name: CP Safe Update

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'GCP environment.'
        required: true
        default: 'demo'
        type: choice
        options:
          - demo
          - uat
          - prod
      image_tag:
        description: 'Docker image tag to deploy. Use auto for unique tags (recommended).'
        required: false
        default: 'auto'
      dry_run:
        description: 'If true, build/push images + terraform plan only (no apply).'
        required: false
        default: false
        type: boolean
      skip_image_build:
        description: 'If true, run terraform checks/plan only (skip docker build/push). Must be used with dry_run=true.'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

concurrency:
  group: cp-safe-update-${{ inputs.target_environment }}
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: waooaw-oauth
  GCP_REGION: asia-south1
  GCP_REGISTRY: asia-south1-docker.pkg.dev/waooaw-oauth/waooaw

jobs:
  cp-safe-update:
    name: CP Safe Update
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate CP paths
        run: |
          test -d src/CP/BackEnd
          test -d src/CP/FrontEnd

      - name: Generate Image Tag
        id: image_tag
        run: |
          set -euo pipefail
          TARGET_ENV="${{ inputs.target_environment }}"
          if [ "${{ inputs.image_tag }}" = "auto" ]; then
            TAG="${TARGET_ENV}-$(echo ${{ github.sha }} | cut -c1-7)-${{ github.run_number }}"
          else
            TAG="${{ inputs.image_tag }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Using image tag: $TAG"

      - name: Validate Inputs
        run: |
          set -euo pipefail
          if [ "${{ inputs.skip_image_build }}" = "true" ] && [ "${{ inputs.dry_run }}" != "true" ]; then
            echo "skip_image_build=true requires dry_run=true to avoid deploying non-existent image tags."
            exit 1
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform FMT Check
        working-directory: cloud/terraform
        run: terraform fmt -recursive -check

      - name: Terraform Validate (no backend)
        working-directory: cloud/terraform
        run: |
          terraform init -backend=false -input=false
          terraform validate

      - name: Terraform Init (remote state)
        working-directory: cloud/terraform
        run: |
          set -euo pipefail
          TARGET_ENV="${{ inputs.target_environment }}"
          terraform init \
            -backend-config="prefix=env/${TARGET_ENV}" \
            -force-copy \
            -reconfigure \
            -input=false

      - name: Terraform Plan
        working-directory: cloud/terraform
        run: |
          set -euo pipefail
          TARGET_ENV="${{ inputs.target_environment }}"
          TAG="${{ steps.image_tag.outputs.tag }}"
          terraform plan \
            -var-file=environments/${TARGET_ENV}.tfvars \
            -var="enable_cp=true" \
            -var="enable_pp=false" \
            -var="enable_plant=false" \
            -var="cp_frontend_image=${{ env.GCP_REGISTRY }}/cp:${TAG}" \
            -var="cp_backend_image=${{ env.GCP_REGISTRY }}/cp-backend:${TAG}" \
            -out=${TARGET_ENV}.tfplan

      - name: Configure Docker for GCP
        if: inputs.skip_image_build != true
        run: gcloud auth configure-docker asia-south1-docker.pkg.dev

      - name: Build & Push CP Backend
        if: inputs.skip_image_build != true
        run: |
          set -euo pipefail
          TAG="${{ steps.image_tag.outputs.tag }}"
          docker build \
            -t ${{ env.GCP_REGISTRY }}/cp-backend:${TAG} \
            -t ${{ env.GCP_REGISTRY }}/cp-backend:latest \
            -f src/CP/BackEnd/Dockerfile \
            src/CP/BackEnd
          docker push ${{ env.GCP_REGISTRY }}/cp-backend:${TAG}
          docker push ${{ env.GCP_REGISTRY }}/cp-backend:latest

      - name: Build & Push CP Frontend
        if: inputs.skip_image_build != true
        run: |
          set -euo pipefail
          TAG="${{ steps.image_tag.outputs.tag }}"
          docker build \
            -t ${{ env.GCP_REGISTRY }}/cp:${TAG} \
            -t ${{ env.GCP_REGISTRY }}/cp:latest \
            --build-arg VITE_ENVIRONMENT="${{ inputs.target_environment }}" \
            -f src/CP/FrontEnd/Dockerfile \
            src/CP/FrontEnd
          docker push ${{ env.GCP_REGISTRY }}/cp:${TAG}
          docker push ${{ env.GCP_REGISTRY }}/cp:latest

      - name: Terraform Apply
        if: inputs.dry_run != true && inputs.skip_image_build != true
        working-directory: cloud/terraform
        run: |
          set -euo pipefail
          TARGET_ENV="${{ inputs.target_environment }}"
          terraform apply -auto-approve "${TARGET_ENV}.tfplan"

      - name: Smoke Test (LB)
        if: inputs.dry_run != true && inputs.skip_image_build != true
        continue-on-error: true
        run: |
          TARGET_ENV="${{ inputs.target_environment }}"
          LB_URL="https://cp.${TARGET_ENV}.waooaw.com"
          echo "Testing: $LB_URL"
          curl -fsS -o /dev/null "$LB_URL" || true
