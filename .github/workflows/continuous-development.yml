name: Continuous Development
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  vision-context:
    runs-on: ubuntu-latest
    outputs:
      phase: ${{ steps.detect-phase.outputs.phase }}
      context: ${{ steps.detect-phase.outputs.context }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect WowVision Phase
        id: detect-phase
        run: |
          # WowVision Phase Detection
          PHASE="unknown"
          CONTEXT=""
          
          # Check for vision markers in recent commits
          if git log -1 --pretty=%B | grep -qi "vision\|phase\|wow"; then
            if git log -1 --pretty=%B | grep -qi "phase 1\|initialization\|foundation"; then
              PHASE="phase1"
              CONTEXT="Foundation & Initialization"
            elif git log -1 --pretty=%B | grep -qi "phase 2\|core\|implementation"; then
              PHASE="phase2"
              CONTEXT="Core Implementation"
            elif git log -1 --pretty=%B | grep -qi "phase 3\|enhancement\|refinement"; then
              PHASE="phase3"
              CONTEXT="Enhancement & Refinement"
            elif git log -1 --pretty=%B | grep -qi "phase 4\|integration\|completion"; then
              PHASE="phase4"
              CONTEXT="Integration & Completion"
            fi
          fi
          
          echo "phase=$PHASE" >> $GITHUB_OUTPUT
          echo "context=$CONTEXT" >> $GITHUB_OUTPUT
          echo "Detected Phase: $PHASE - $CONTEXT"

  vision-stack-validation:
    runs-on: ubuntu-latest
    needs: vision-context
    outputs:
      validation_result: ${{ steps.validate.outputs.result }}
      violations: ${{ steps.validate.outputs.violations }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate changes with Vision Stack
        id: validate
        env:
          VISION_PHASE: ${{ needs.vision-context.outputs.phase }}
        run: |
          python - <<'EOF'
          import os
          import sys
          import subprocess
          import json
          from pathlib import Path
          
          # Add scripts to path
          sys.path.insert(0, str(Path.cwd() / "scripts"))
          
          from vision_stack import VisionStack
          
          def get_changed_files():
              """Get list of changed files in this PR/commit."""
              try:
                  if os.getenv('GITHUB_EVENT_NAME') == 'pull_request':
                      result = subprocess.run(
                          ['git', 'diff', '--name-only', 'origin/main...HEAD'],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                  else:
                      result = subprocess.run(
                          ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                  return [f for f in result.stdout.strip().split('\n') if f]
              except subprocess.CalledProcessError as e:
                  print(f"Error getting changed files: {e}")
                  return []
          
          # Initialize vision stack
          try:
              vision = VisionStack()
              print("‚úÖ Vision stack loaded successfully")
          except Exception as e:
              print(f"‚ùå Failed to load vision stack: {e}")
              sys.exit(1)
          
          # Get changed files
          changed_files = get_changed_files()
          print(f"\nüìÅ Changed files: {len(changed_files)}")
          
          violations = []
          approved_count = 0
          
          # Validate each file creation
          for file_path in changed_files:
              # Skip if file is in vision/ directory (vision files themselves)
              if file_path.startswith('vision/'):
                  print(f"‚è≠Ô∏è  Skipping vision file: {file_path}")
                  continue
              
              # Check if file is newly created using git diff
              try:
                  result = subprocess.run(
                      ['git', 'diff', '--diff-filter=A', '--name-only', 'HEAD~1', 'HEAD', '--', file_path],
                      capture_output=True,
                      text=True
                  )
                  is_new_file = bool(result.stdout.strip())
              except:
                  is_new_file = False
              
              if is_new_file:
                  # Validate file creation
                  approved, reason, citations = vision.validate_action(
                      agent_id="GitHubActions",
                      action={
                          "type": "create_file",
                          "path": file_path
                      }
                  )
                  
                  if approved:
                      print(f"‚úÖ {file_path}: {reason}")
                      approved_count += 1
                  else:
                      print(f"‚ùå {file_path}: {reason}")
                      print(f"   Citations: {', '.join(citations)}")
                      violations.append({
                          "file": file_path,
                          "reason": reason,
                          "citations": citations
                      })
          
          # Output results
          result_summary = f"Validated {len(changed_files)} files: {approved_count} approved, {len(violations)} violations"
          print(f"\nüìä {result_summary}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"result={result_summary}\n")
              if violations:
                  # Write violations as base64-encoded JSON to avoid injection
                  import base64
                  violations_json = json.dumps(violations)
                  violations_b64 = base64.b64encode(violations_json.encode()).decode()
                  f.write(f"violations={violations_b64}\n")
              else:
                  f.write("violations=\n")
          
          # Exit with error if there are violations
          if violations:
              print("\n‚ö†Ô∏è  Vision stack violations detected!")
              sys.exit(1)
          
          print("\n‚úÖ All validations passed")
          EOF

  analyze:
    runs-on: ubuntu-latest
    needs: [vision-context, vision-stack-validation]
    outputs:
      analysis_result: ${{ steps.analyze.outputs.result }}
      suggestions: ${{ steps.analyze.outputs.suggestions }}
      risk_level: ${{ steps.analyze.outputs.risk_level }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic requests

      - name: Analyze changes
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VISION_PHASE: ${{ needs.vision-context.outputs.phase }}
          VISION_CONTEXT: ${{ needs.vision-context.outputs.context }}
        run: |
          python - <<'EOF'
          import anthropic
          import os
          import subprocess
          import json

          def get_diff():
              try:
                  if os.getenv('GITHUB_EVENT_NAME') == 'pull_request':
                      result = subprocess.run(
                          ['git', 'diff', 'origin/main...HEAD'],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                  else:
                      result = subprocess.run(
                          ['git', 'diff', 'HEAD~1', 'HEAD'],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                  return result.stdout
              except subprocess.CalledProcessError as e:
                  print(f"Error getting diff: {e}")
                  return ""

          def analyze_with_claude(diff, vision_phase, vision_context):
              client = anthropic.Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))
              
              vision_info = ""
              if vision_phase != "unknown":
                  vision_info = f"\n\nWowVision Context: {vision_phase} - {vision_context}"
              
              prompt = f"""Analyze this code change and provide:
          1. A brief summary of what changed
          2. Potential issues or concerns
          3. Suggestions for improvement
          4. Risk level (low/medium/high)
          {vision_info}

          Diff:
          {diff[:4000]}

          Provide response in JSON format with keys: summary, concerns, suggestions, risk_level"""

              message = client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=1024,
                  messages=[
                      {"role": "user", "content": prompt}
                  ]
              )
              
              return message.content[0].text

          diff = get_diff()
          if not diff:
              print("No changes detected")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("result=No changes detected\n")
                  f.write("suggestions=None\n")
                  f.write("risk_level=low\n")
              exit(0)

          vision_phase = os.getenv('VISION_PHASE', 'unknown')
          vision_context = os.getenv('VISION_CONTEXT', '')
          analysis = analyze_with_claude(diff, vision_phase, vision_context)
          
          try:
              analysis_json = json.loads(analysis)
              result = analysis_json.get('summary', 'Analysis complete')
              suggestions = analysis_json.get('suggestions', 'No suggestions')
              risk_level = analysis_json.get('risk_level', 'low')
          except json.JSONDecodeError:
              result = analysis[:200]
              suggestions = "See full analysis"
              risk_level = "low"

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"result={result}\n")
              f.write(f"suggestions={suggestions}\n")
              f.write(f"risk_level={risk_level}\n")

          print(f"Analysis complete. Risk level: {risk_level}")
          EOF

  test:
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=. --cov-report=term-missing
          else
            echo "No tests directory found"
          fi

  auto-improve:
    runs-on: ubuntu-latest
    needs: [vision-context, analyze, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic requests

      - name: Generate improvements
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANALYSIS_RESULT: ${{ needs.analyze.outputs.analysis_result }}
          SUGGESTIONS: ${{ needs.analyze.outputs.suggestions }}
          RISK_LEVEL: ${{ needs.analyze.outputs.risk_level }}
          VISION_PHASE: ${{ needs.vision-context.outputs.phase }}
          VISION_CONTEXT: ${{ needs.vision-context.outputs.context }}
        run: |
          python - <<'EOF'
          import anthropic
          import os
          import subprocess
          import json

          def get_project_context():
              try:
                  result = subprocess.run(
                      ['find', '.', '-type', 'f', '-name', '*.py', '-o', '-name', '*.md'],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  return result.stdout
              except subprocess.CalledProcessError:
                  return ""

          def generate_improvements(analysis, suggestions, risk_level, vision_phase, vision_context):
              client = anthropic.Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))
              
              vision_info = ""
              if vision_phase != "unknown":
                  vision_info = f"\n\nWowVision Context: {vision_phase} - {vision_context}"
                  vision_info += "\nAlign improvements with current phase objectives."
              
              prompt = f"""Based on this analysis, suggest concrete improvements:

          Analysis: {analysis}
          Suggestions: {suggestions}
          Risk Level: {risk_level}
          {vision_info}

          Provide specific, actionable improvements that could be implemented.
          Format as JSON with: {{improvements: [list of improvements], priority: high/medium/low}}"""

              message = client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=2048,
                  messages=[
                      {"role": "user", "content": prompt}
                  ]
              )
              
              return message.content[0].text

          analysis = os.getenv('ANALYSIS_RESULT', '')
          suggestions = os.getenv('SUGGESTIONS', '')
          risk_level = os.getenv('RISK_LEVEL', 'low')
          vision_phase = os.getenv('VISION_PHASE', 'unknown')
          vision_context = os.getenv('VISION_CONTEXT', '')

          if analysis:
              improvements = generate_improvements(analysis, suggestions, risk_level, vision_phase, vision_context)
              print("Generated Improvements:")
              print(improvements)
              
              with open('improvements.json', 'w') as f:
                  f.write(improvements)
          else:
              print("No analysis available for improvements")
          EOF

      - name: Create improvement branch
        if: hashFiles('improvements.json') != ''
        run: |
          BRANCH_NAME="auto-improve-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH_NAME
          git add improvements.json
          git commit -m "Auto-generated improvements

          Based on continuous development analysis.
          Vision Phase: ${{ needs.vision-context.outputs.phase }}
          Context: ${{ needs.vision-context.outputs.context }}"
          git push origin $BRANCH_NAME
          echo "IMPROVEMENT_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.IMPROVEMENT_BRANCH != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head ${{ env.IMPROVEMENT_BRANCH }} \
            --title "ü§ñ Auto-generated Improvements" \
            --body "Automated improvements based on continuous development analysis.

          **Vision Context**: ${{ needs.vision-context.outputs.phase }} - ${{ needs.vision-context.outputs.context }}
          **Analysis Risk Level**: ${{ needs.analyze.outputs.risk_level }}

          Please review the suggested improvements in \`improvements.json\`."

  notify:
    runs-on: ubuntu-latest
    needs: [vision-context, vision-stack-validation, analyze, test, auto-improve]
    if: always()
    steps:
      - name: Create status summary
        id: create-status
        run: |
          echo "status=Workflow completed - Vision: ${{ needs.vision-context.outputs.phase }}, Risk: ${{ needs.analyze.outputs.risk_level }}" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ü§ñ Continuous Development Report

          **WowVision Phase**: ${{ needs.vision-context.outputs.phase }} - ${{ needs.vision-context.outputs.context }}
          **Vision Stack**: ${{ needs.vision-stack-validation.outputs.validation_result }}
          **Analysis**: ${{ needs.analyze.outputs.analysis_result }}
          **Risk Level**: ${{ needs.analyze.outputs.risk_level }}
          **Test Status**: ${{ needs.test.result }}

          **Suggestions**: ${{ needs.analyze.outputs.suggestions }}"

      - name: Create issue for vision violations
        if: needs.vision-stack-validation.outputs.violations != '' && needs.vision-stack-validation.result == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Decode violations from base64
          VIOLATIONS_B64="${{ needs.vision-stack-validation.outputs.violations }}"
          if [ -n "$VIOLATIONS_B64" ]; then
            VIOLATIONS=$(echo "$VIOLATIONS_B64" | base64 -d)
            gh issue create \
              --title "‚ö†Ô∏è Vision Stack Violations Detected" \
              --body "Vision stack violations detected in workflow run: ${{ github.run_id }}
            
          Please review and address the violations before merging.
          
          See workflow logs for details." \
              --label "vision-violation,auto-generated"
          fi

      - name: Create issue for high-risk changes
        if: needs.analyze.outputs.risk_level == 'high'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "‚ö†Ô∏è High-risk changes detected" \
            --body "High-risk changes detected in workflow run: ${{ github.run_id }}" \
            --label "high-risk,auto-generated"
