name: Continuous Development
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  vision-context:
    runs-on: ubuntu-latest
    outputs:
      phase: ${{ steps.detect-phase.outputs.phase }}
      context: ${{ steps.detect-phase.outputs.context }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect WowVision Phase
        id: detect-phase
        run: |
          # WowVision Phase Detection
          PHASE="unknown"
          CONTEXT=""
          
          # Check for vision markers in recent commits
          if git log -1 --pretty=%B | grep -qi "vision\|phase\|wow"; then
            if git log -1 --pretty=%B | grep -qi "phase 1\|initialization\|foundation"; then
              PHASE="phase1"
              CONTEXT="Foundation & Initialization"
            elif git log -1 --pretty=%B | grep -qi "phase 2\|core\|implementation"; then
              PHASE="phase2"
              CONTEXT="Core Implementation"
            elif git log -1 --pretty=%B | grep -qi "phase 3\|enhancement\|refinement"; then
              PHASE="phase3"
              CONTEXT="Enhancement & Refinement"
            elif git log -1 --pretty=%B | grep -qi "phase 4\|integration\|completion"; then
              PHASE="phase4"
              CONTEXT="Integration & Completion"
            fi
          fi
          
          echo "phase=$PHASE" >> $GITHUB_OUTPUT
          echo "context=$CONTEXT" >> $GITHUB_OUTPUT
          echo "Detected Phase: $PHASE - $CONTEXT"

  analyze:
    runs-on: ubuntu-latest
    needs: vision-context
    outputs:
      analysis_result: ${{ steps.analyze.outputs.result }}
      suggestions: ${{ steps.analyze.outputs.suggestions }}
      risk_level: ${{ steps.analyze.outputs.risk_level }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic requests

      - name: Analyze changes
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VISION_PHASE: ${{ needs.vision-context.outputs.phase }}
          VISION_CONTEXT: ${{ needs.vision-context.outputs.context }}
        run: |
          python - <<'EOF'
          import anthropic
          import os
          import subprocess
          import json

          def get_diff():
              try:
                  if os.getenv('GITHUB_EVENT_NAME') == 'pull_request':
                      result = subprocess.run(
                          ['git', 'diff', 'origin/main...HEAD'],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                  else:
                      result = subprocess.run(
                          ['git', 'diff', 'HEAD~1', 'HEAD'],
                          capture_output=True,
                          text=True,
                          check=True
                      )
                  return result.stdout
              except subprocess.CalledProcessError as e:
                  print(f"Error getting diff: {e}")
                  return ""

          def analyze_with_claude(diff, vision_phase, vision_context):
              client = anthropic.Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))
              
              vision_info = ""
              if vision_phase != "unknown":
                  vision_info = f"\n\nWowVision Context: {vision_phase} - {vision_context}"
              
              prompt = f"""Analyze this code change and provide:
          1. A brief summary of what changed
          2. Potential issues or concerns
          3. Suggestions for improvement
          4. Risk level (low/medium/high)
          {vision_info}

          Diff:
          {diff[:4000]}

          Provide response in JSON format with keys: summary, concerns, suggestions, risk_level"""

              message = client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=1024,
                  messages=[
                      {"role": "user", "content": prompt}
                  ]
              )
              
              return message.content[0].text

          diff = get_diff()
          if not diff:
              print("No changes detected")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("result=No changes detected\n")
                  f.write("suggestions=None\n")
                  f.write("risk_level=low\n")
              exit(0)

          vision_phase = os.getenv('VISION_PHASE', 'unknown')
          vision_context = os.getenv('VISION_CONTEXT', '')
          analysis = analyze_with_claude(diff, vision_phase, vision_context)
          
          try:
              analysis_json = json.loads(analysis)
              result = analysis_json.get('summary', 'Analysis complete')
              suggestions = analysis_json.get('suggestions', 'No suggestions')
              risk_level = analysis_json.get('risk_level', 'low')
          except json.JSONDecodeError:
              result = analysis[:200]
              suggestions = "See full analysis"
              risk_level = "low"

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"result={result}\n")
              f.write(f"suggestions={suggestions}\n")
              f.write(f"risk_level={risk_level}\n")

          print(f"Analysis complete. Risk level: {risk_level}")
          EOF

  test:
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=. --cov-report=term-missing
          else
            echo "No tests directory found"
          fi

  auto-improve:
    runs-on: ubuntu-latest
    needs: [vision-context, analyze, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic requests

      - name: Generate improvements
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANALYSIS_RESULT: ${{ needs.analyze.outputs.analysis_result }}
          SUGGESTIONS: ${{ needs.analyze.outputs.suggestions }}
          RISK_LEVEL: ${{ needs.analyze.outputs.risk_level }}
          VISION_PHASE: ${{ needs.vision-context.outputs.phase }}
          VISION_CONTEXT: ${{ needs.vision-context.outputs.context }}
        run: |
          python - <<'EOF'
          import anthropic
          import os
          import subprocess
          import json

          def get_project_context():
              try:
                  result = subprocess.run(
                      ['find', '.', '-type', 'f', '-name', '*.py', '-o', '-name', '*.md'],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  return result.stdout
              except subprocess.CalledProcessError:
                  return ""

          def generate_improvements(analysis, suggestions, risk_level, vision_phase, vision_context):
              client = anthropic.Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))
              
              vision_info = ""
              if vision_phase != "unknown":
                  vision_info = f"\n\nWowVision Context: {vision_phase} - {vision_context}"
                  vision_info += "\nAlign improvements with current phase objectives."
              
              prompt = f"""Based on this analysis, suggest concrete improvements:

          Analysis: {analysis}
          Suggestions: {suggestions}
          Risk Level: {risk_level}
          {vision_info}

          Provide specific, actionable improvements that could be implemented.
          Format as JSON with: {{improvements: [list of improvements], priority: high/medium/low}}"""

              message = client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=2048,
                  messages=[
                      {"role": "user", "content": prompt}
                  ]
              )
              
              return message.content[0].text

          analysis = os.getenv('ANALYSIS_RESULT', '')
          suggestions = os.getenv('SUGGESTIONS', '')
          risk_level = os.getenv('RISK_LEVEL', 'low')
          vision_phase = os.getenv('VISION_PHASE', 'unknown')
          vision_context = os.getenv('VISION_CONTEXT', '')

          if analysis:
              improvements = generate_improvements(analysis, suggestions, risk_level, vision_phase, vision_context)
              print("Generated Improvements:")
              print(improvements)
              
              with open('improvements.json', 'w') as f:
                  f.write(improvements)
          else:
              print("No analysis available for improvements")
          EOF

      - name: Create improvement branch
        if: hashFiles('improvements.json') != ''
        run: |
          BRANCH_NAME="auto-improve-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH_NAME
          git add improvements.json
          git commit -m "Auto-generated improvements

          Based on continuous development analysis.
          Vision Phase: ${{ needs.vision-context.outputs.phase }}
          Context: ${{ needs.vision-context.outputs.context }}"
          git push origin $BRANCH_NAME
          echo "IMPROVEMENT_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.IMPROVEMENT_BRANCH != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head ${{ env.IMPROVEMENT_BRANCH }} \
            --title "ü§ñ Auto-generated Improvements" \
            --body "Automated improvements based on continuous development analysis.

          **Vision Context**: ${{ needs.vision-context.outputs.phase }} - ${{ needs.vision-context.outputs.context }}
          **Analysis Risk Level**: ${{ needs.analyze.outputs.risk_level }}

          Please review the suggested improvements in \`improvements.json\`."

  notify:
    runs-on: ubuntu-latest
    needs: [vision-context, analyze, test, auto-improve]
    if: always()
    steps:
      - name: Create status summary
        id: create-status
        run: |
          echo "status=Workflow completed - Vision: ${{ needs.vision-context.outputs.phase }}, Risk: ${{ needs.analyze.outputs.risk_level }}" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ü§ñ Continuous Development Report

          **WowVision Phase**: ${{ needs.vision-context.outputs.phase }} - ${{ needs.vision-context.outputs.context }}
          **Analysis**: ${{ needs.analyze.outputs.analysis_result }}
          **Risk Level**: ${{ needs.analyze.outputs.risk_level }}
          **Test Status**: ${{ needs.test.result }}

          **Suggestions**: ${{ needs.analyze.outputs.suggestions }}"

      - name: Create issue for high-risk changes
        if: needs.analyze.outputs.risk_level == 'high'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "‚ö†Ô∏è High-risk changes detected" \
            --body "High-risk changes detected in workflow run: ${{ github.run_id }}" \
            --label "high-risk,auto-generated"
