name: Plant Backend - Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - demo
          - uat
          - prod
      migration_type:
        description: 'Migration type'
        required: true
        type: choice
        options:
          - upgrade
          - seed
          - both

  push:
    branches:
      - main
    paths:
      - 'src/Plant/BackEnd/database/migrations/versions/**'
      - 'src/Plant/BackEnd/alembic.ini'
      - '.github/workflows/plant-db-migrations.yml'

jobs:
  migrate-demo:
    name: Migrate Demo Database
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'demo')
    environment: demo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/Plant/BackEnd
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME_DEMO }}=tcp:5432 &
          sleep 5

      - name: Verify Cloud SQL RUNNABLE
        run: |
          set -euo pipefail
          echo "Checking Cloud SQL instance state..."
          STATE=$(gcloud sql instances describe plant-sql-demo --format="value(state)" 2>&1)
          echo "Current state: $STATE"
          if [ "$STATE" != "RUNNABLE" ]; then
            echo "::error::Cloud SQL instance plant-sql-demo is in state: $STATE"
            echo "::error::Database must be RUNNABLE before running migrations."
            echo "::error::Wait for instance to become RUNNABLE or check GCP console for issues."
            exit 1
          fi
          echo "✅ Cloud SQL instance is RUNNABLE"

      - name: Run migrations
        if: github.event.inputs.migration_type == 'upgrade' || github.event.inputs.migration_type == 'both' || github.event_name == 'push'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEMO }}
        run: |
          cd src/Plant/BackEnd
          ./scripts/migrate-db.sh demo

      - name: Seed Genesis data
        if: github.event.inputs.migration_type == 'seed' || github.event.inputs.migration_type == 'both'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEMO }}
        run: |
          cd src/Plant/BackEnd
          ./scripts/seed-db.sh demo

      - name: Verify migration
        run: |
          cd src/Plant/BackEnd
          alembic current
          echo "✅ Demo database migration verified"

      - name: Smoke test database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEMO }}
        run: |
          set -euo pipefail
          echo "Running database smoke tests..."

          # Test 1: Agents table has data
          AGENT_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM agents;" | xargs)
          echo "Agents count: $AGENT_COUNT"
          if [ "$AGENT_COUNT" -lt 1 ]; then
            echo "::error::Agents table is empty. Expected at least 1 row."
            exit 1
          fi

          # Test 2: Skills table exists and has data
          SKILL_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM skills;" | xargs)
          echo "Skills count: $SKILL_COUNT"
          if [ "$SKILL_COUNT" -lt 1 ]; then
            echo "::error::Skills table is empty. Expected at least 1 row."
            exit 1
          fi

          # Test 3: Alembic version table has exactly 1 row
          VERSION_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM alembic_version;" | xargs)
          echo "Alembic version entries: $VERSION_COUNT"
          if [ "$VERSION_COUNT" -ne 1 ]; then
            echo "::error::Alembic version table should have exactly 1 row, found: $VERSION_COUNT"
            exit 1
          fi

          echo "✅ All database smoke tests passed"

  migrate-uat:
    name: Migrate UAT Database
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'uat'
    environment: uat
    needs: []  # No dependency on demo for manual triggers

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/Plant/BackEnd
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME_UAT }}=tcp:5432 &
          sleep 5

      - name: Verify Cloud SQL RUNNABLE
        run: |
          set -euo pipefail
          echo "Checking Cloud SQL instance state..."
          STATE=$(gcloud sql instances describe plant-sql-uat --format="value(state)" 2>&1)
          echo "Current state: $STATE"
          if [ "$STATE" != "RUNNABLE" ]; then
            echo "::error::Cloud SQL instance plant-sql-uat is in state: $STATE"
            echo "::error::Database must be RUNNABLE before running migrations."
            echo "::error::Wait for instance to become RUNNABLE or check GCP console for issues."
            exit 1
          fi
          echo "✅ Cloud SQL instance is RUNNABLE"

      - name: Run migrations
        if: github.event.inputs.migration_type == 'upgrade' || github.event.inputs.migration_type == 'both'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UAT }}
        run: |
          cd src/Plant/BackEnd
          ./scripts/migrate-db.sh uat

      - name: Seed Genesis data
        if: github.event.inputs.migration_type == 'seed' || github.event.inputs.migration_type == 'both'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UAT }}
        run: |
          cd src/Plant/BackEnd
          ./scripts/seed-db.sh uat

      - name: Verify migration
        run: |
          cd src/Plant/BackEnd
          alembic current
          echo "✅ UAT database migration verified"

      - name: Smoke test database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UAT }}
        run: |
          set -euo pipefail
          echo "Running database smoke tests..."

          # Test 1: Agents table has data
          AGENT_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM agents;" | xargs)
          echo "Agents count: $AGENT_COUNT"
          if [ "$AGENT_COUNT" -lt 1 ]; then
            echo "::error::Agents table is empty. Expected at least 1 row."
            exit 1
          fi

          # Test 2: Skills table exists and has data
          SKILL_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM skills;" | xargs)
          echo "Skills count: $SKILL_COUNT"
          if [ "$SKILL_COUNT" -lt 1 ]; then
            echo "::error::Skills table is empty. Expected at least 1 row."
            exit 1
          fi

          # Test 3: Alembic version table has exactly 1 row
          VERSION_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM alembic_version;" | xargs)
          echo "Alembic version entries: $VERSION_COUNT"
          if [ "$VERSION_COUNT" -ne 1 ]; then
            echo "::error::Alembic version table should have exactly 1 row, found: $VERSION_COUNT"
            exit 1
          fi

          echo "✅ All database smoke tests passed"

  migrate-prod:
    name: Migrate Production Database
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/Plant/BackEnd
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME_PROD }}=tcp:5432 &
          sleep 5

      - name: Verify Cloud SQL RUNNABLE
        run: |
          set -euo pipefail
          echo "Checking Cloud SQL instance state..."
          STATE=$(gcloud sql instances describe plant-sql-prod --format="value(state)" 2>&1)
          echo "Current state: $STATE"
          if [ "$STATE" != "RUNNABLE" ]; then
            echo "::error::Cloud SQL instance plant-sql-prod is in state: $STATE"
            echo "::error::Database must be RUNNABLE before running migrations."
            echo "::error::Wait for instance to become RUNNABLE or check GCP console for issues."
            exit 1
          fi
          echo "✅ Cloud SQL instance is RUNNABLE"

      - name: Create database backup
        run: |
          gcloud sql backups create \
            --instance=${{ secrets.CLOUD_SQL_INSTANCE_NAME_PROD }} \
            --project=${{ secrets.GCP_PROJECT_ID }}
          echo "✅ Pre-migration backup created"

      - name: Run migrations
        if: github.event.inputs.migration_type == 'upgrade' || github.event.inputs.migration_type == 'both'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          cd src/Plant/BackEnd
          ./scripts/migrate-db.sh prod

      - name: Seed Genesis data
        if: github.event.inputs.migration_type == 'seed' || github.event.inputs.migration_type == 'both'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          cd src/Plant/BackEnd
          ./scripts/seed-db.sh prod

      - name: Verify migration
        run: |
          cd src/Plant/BackEnd
          alembic current
          echo "✅ Production database migration verified"

      - name: Smoke test database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
        run: |
          set -euo pipefail
          echo "Running database smoke tests..."

          # Test 1: Agents table has data
          AGENT_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM agents;" | xargs)
          echo "Agents count: $AGENT_COUNT"
          if [ "$AGENT_COUNT" -lt 1 ]; then
            echo "::error::Agents table is empty. Expected at least 1 row."
            exit 1
          fi

          # Test 2: Skills table exists and has data
          SKILL_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM skills;" | xargs)
          echo "Skills count: $SKILL_COUNT"
          if [ "$SKILL_COUNT" -lt 1 ]; then
            echo "::error::Skills table is empty. Expected at least 1 row."
            exit 1
          fi

          # Test 3: Alembic version table has exactly 1 row
          VERSION_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM alembic_version;" | xargs)
          echo "Alembic version entries: $VERSION_COUNT"
          if [ "$VERSION_COUNT" -ne 1 ]; then
            echo "::error::Alembic version table should have exactly 1 row, found: $VERSION_COUNT"
            exit 1
          fi

          echo "✅ All database smoke tests passed"

      - name: Run smoke tests
        run: |
          # Basic smoke tests post-migration
          cd src/Plant/BackEnd
          pytest tests/integration/test_database_connection.py -v
          echo "✅ Smoke tests passed"
