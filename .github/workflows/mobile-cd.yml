name: Mobile CD (Deployment)

on:
  push:
    tags:
      - 'mobile-v*.*.*'           # Production: mobile-v1.2.3
      - 'mobile-v*.*.*-beta.*'    # Staging: mobile-v1.2.3-beta.1
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      platform:
        description: 'Build platform'
        required: true
        type: choice
        options:
          - all
          - ios
          - android

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      version: ${{ steps.env.outputs.version }}
      is-production: ${{ steps.env.outputs.is-production }}
    
    steps:
      - name: Determine environment from tag or input
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "version=manual-${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "is-production=${{ github.event.inputs.environment == 'production' }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ mobile-v([0-9]+\.[0-9]+\.[0-9]+)-beta\. ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ mobile-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "is-production=true" >> $GITHUB_OUTPUT
          else
            echo "Invalid tag format" && exit 1
          fi

  build-and-submit:
    name: Build & Submit to Stores
    runs-on: ubuntu-latest
    needs: determine-environment
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/mobile/package-lock.json
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Install dependencies
        working-directory: src/mobile
        run: npm ci
      
      - name: Update version in app.json
        working-directory: src/mobile
        run: |
          VERSION="${{ needs.determine-environment.outputs.version }}"
          jq ".expo.version = \"$VERSION\"" app.json > app.json.tmp
          mv app.json.tmp app.json
      
      - name: Build iOS
        if: github.event.inputs.platform != 'android'
        working-directory: src/mobile
        run: |
          eas build \
            --profile ${{ needs.determine-environment.outputs.environment }} \
            --platform ios \
            --non-interactive \
            --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          EXPO_APPLE_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      
      - name: Build Android
        if: github.event.inputs.platform != 'ios'
        working-directory: src/mobile
        run: |
          eas build \
            --profile ${{ needs.determine-environment.outputs.environment }} \
            --platform android \
            --non-interactive \
            --auto-submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_KEY }}
      
      - name: Publish OTA update
        if: needs.determine-environment.outputs.environment == 'production'
        working-directory: src/mobile
        run: |
          eas update \
            --branch production \
            --message "Production release ${{ needs.determine-environment.outputs.version }}"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: Create GitHub Release
        if: needs.determine-environment.outputs.is-production == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Mobile App v${{ needs.determine-environment.outputs.version }}
          body: |
            ## WAOOAW Mobile App - Production Release
            
            **Version**: ${{ needs.determine-environment.outputs.version }}
            **Build Date**: ${{ github.event.head_commit.timestamp }}
            
            ### ðŸ“± Download Links
            - **iOS**: [TestFlight](https://testflight.apple.com/join/YOUR_TESTFLIGHT_LINK)
            - **Android**: [Google Play](https://play.google.com/store/apps/details?id=com.waooaw.app)
            
            ### ðŸ“¦ Build Status
            Check build progress: https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds
            
            ### ðŸš€ Deployment
            - iOS submitted to App Store Connect
            - Android submitted to Google Play Console
            - OTA update published to production channel
          draft: false
          prerelease: false
      
      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Mobile app deployment ${{ job.status }}!
            Environment: ${{ needs.determine-environment.outputs.environment }}
            Version: ${{ needs.determine-environment.outputs.version }}
            Build URL: https://expo.dev/accounts/waooaw/projects/waooaw-mobile/builds
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  rollback-on-failure:
    name: Rollback on High Error Rate
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-submit]
    if: failure() && needs.determine-environment.outputs.is-production == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Rollback OTA update
        working-directory: src/mobile
        run: |
          # Get previous successful version and republish
          eas update:republish --branch production --group previous
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: Notify team of rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš¨ MOBILE APP ROLLBACK INITIATED ðŸš¨",
              attachments: [{
                color: 'danger',
                text: 'Production deployment failed. OTA update rolled back to previous version.'
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
