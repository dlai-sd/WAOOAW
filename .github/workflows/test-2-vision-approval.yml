name: "Test 2: Vision Approval"

on:
  workflow_dispatch:
    inputs:
      test_file:
        description: 'Test file name (default: test_approval.md)'
        required: false
        default: 'test_approval.md'

jobs:
  test-vision-approval:
    name: "Test: Markdown file in Phase 1 (should APPROVE)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r waooaw/requirements.txt
      
      - name: Create Markdown file (allowed in Phase 1)
        run: |
          cat > ${{ github.event.inputs.test_file }} << 'EOF'
          # Test Documentation File
          
          This markdown file should be APPROVED by WowVision Prime.
          
          Phase 1 allows documentation files (.md, .yaml, .sql).
          EOF
          
          echo "ðŸ“ Created test file: ${{ github.event.inputs.test_file }}"
          cat ${{ github.event.inputs.test_file }}
      
      - name: Wake WowVision Prime
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_HOST: ${{ secrets.PINECONE_INDEX_HOST }}
          PINECONE_INDEX_NAME: ${{ secrets.PINECONE_INDEX_NAME }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd waooaw
          python main.py wake_up --test-file="../${{ github.event.inputs.test_file }}"
      
      - name: Verify approval (no escalation)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking that NO escalation was created..."
          sleep 5
          
          RECENT_ISSUES=$(gh issue list --repo dlai-sd/waooaw --label wowvision-escalation --limit 1 --json createdAt,title)
          
          if [ "$(echo "$RECENT_ISSUES" | jq '. | length')" -eq "0" ]; then
            echo "âœ… TEST PASSED: No escalation (file approved)"
          else
            LATEST_TITLE=$(echo "$RECENT_ISSUES" | jq -r '.[0].title')
            if [[ "$LATEST_TITLE" == *"${{ github.event.inputs.test_file }}"* ]]; then
              echo "âŒ TEST FAILED: Escalation created for approved file"
              exit 1
            else
              echo "âœ… TEST PASSED: Latest escalation not for this file"
            fi
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Test 2 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test:** Vision Approval" >> $GITHUB_STEP_SUMMARY
          echo "**File:** ${{ github.event.inputs.test_file }}" >> $GITHUB_STEP_SUMMARY
          echo "**Expected:** APPROVE (Markdown allowed in Phase 1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Test completed - No escalation should be created" >> $GITHUB_STEP_SUMMARY
