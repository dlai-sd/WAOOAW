name: Setup Custom Domains

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to setup'
        required: true
        type: choice
        options:
          - demo
          - uat
          - production

env:
  GCP_PROJECT_ID: waooaw-oauth
  GCP_REGION: asia-south1

jobs:
  map-domains:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Map Custom Domains
        run: |
          ENV="${{ github.event.inputs.environment }}"
          
          # Determine service names and domains based on environment
          case "$ENV" in
            demo)
              BACKEND_SERVICE="waooaw-api-demo"
              PORTAL_SERVICE="waooaw-portal-demo"
              PLATFORM_SERVICE="waooaw-platform-portal-demo"
              API_DOMAIN="demo-api.waooaw.com"
              WWW_DOMAIN="demo-www.waooaw.com"
              PP_DOMAIN="demo-pp.waooaw.com"
              ;;
            uat)
              BACKEND_SERVICE="waooaw-api-uat"
              PORTAL_SERVICE="waooaw-portal-uat"
              PLATFORM_SERVICE="waooaw-platform-portal-uat"
              API_DOMAIN="uat-api.waooaw.com"
              WWW_DOMAIN="uat-www.waooaw.com"
              PP_DOMAIN="uat-pp.waooaw.com"
              ;;
            production)
              BACKEND_SERVICE="waooaw-api"
              PORTAL_SERVICE="waooaw-portal"
              PLATFORM_SERVICE="waooaw-platform-portal"
              API_DOMAIN="api.waooaw.com"
              WWW_DOMAIN="www.waooaw.com"
              PP_DOMAIN="pp.waooaw.com"
              ;;
          esac
          
          echo "üîó Creating domain mappings for $ENV environment..."
          echo ""
          
          # Function to create domain mapping
          map_domain() {
            local service=$1
            local domain=$2
            
            echo "üìç Mapping $domain ‚Üí $service"
            
            # Check if mapping exists
            if gcloud run domain-mappings describe "$domain" \
                --region=$GCP_REGION \
                --project=$GCP_PROJECT_ID \
                --format="value(metadata.name)" 2>/dev/null; then
              echo "   ‚ÑπÔ∏è  Domain mapping already exists"
              return 0
            fi
            
            # Create mapping
            if gcloud run domain-mappings create \
                --service="$service" \
                --domain="$domain" \
                --region=$GCP_REGION \
                --project=$GCP_PROJECT_ID 2>&1; then
              echo "   ‚úÖ Mapping created successfully"
              return 0
            else
              echo "   ‚ùå Failed to create mapping"
              return 1
            fi
          }
          
          # Map all domains
          map_domain "$BACKEND_SERVICE" "$API_DOMAIN"
          map_domain "$PORTAL_SERVICE" "$WWW_DOMAIN"
          map_domain "$PLATFORM_SERVICE" "$PP_DOMAIN"
          
          echo ""
          echo "========================================="
          echo "üìã DNS Configuration Required"
          echo "========================================="
          echo "Add these CNAME records to your DNS provider:"
          echo ""
          echo "  $API_DOMAIN ‚Üí ghs.googlehosted.com"
          echo "  $WWW_DOMAIN ‚Üí ghs.googlehosted.com"
          echo "  $PP_DOMAIN ‚Üí ghs.googlehosted.com"
          echo ""
          echo "‚è±Ô∏è  SSL certificates will auto-provision in 15 min - 24 hours"
          echo ""
          echo "üîç Check status:"
          echo "  gcloud run domain-mappings list --region=$GCP_REGION"

      - name: List Domain Mappings
        run: |
          echo ""
          echo "Current domain mappings:"
          gcloud run domain-mappings list --region=$GCP_REGION --project=$GCP_PROJECT_ID

      - name: Notify Completion
        run: |
          echo ""
          echo "‚úÖ Domain mapping workflow completed!"
          echo ""
          echo "Next steps:"
          echo "1. Configure DNS CNAME records (see above)"
          echo "2. Wait for SSL certificate provisioning"
          echo "3. Update Google OAuth Console with custom domains"
          echo "4. Connect frontend Sign In buttons"
