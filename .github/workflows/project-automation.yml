name: GitHub Project Automation

on:
  issues:
    types: [opened, labeled, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, reopened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto-triage:
    name: Auto-Triage Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add to project board
        if: vars.PROJECT_URL != ''
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: ${{ vars.PROJECT_URL }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set agent owner based on labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            // Auto-assign based on label
            let assignee = null;
            if (labels.includes('epic')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['vision-guardian-agent']
              });
              core.info('Epic issue - assigned to Vision Guardian Agent');

              // Create Vision Guardian Review Issue with Agent Task
              const epicTitle = issue.title;
              const epicNumber = issue.number;
              const epicBody = issue.body || '';

              const reviewBody = '## Vision Guardian Agent Task\n\n' +
                '**Epic**: #' + epicNumber + ' - ' + epicTitle + '\n\n' +
                '---\n\n' +
                '## Agent Instructions\n\n' +
                '@github-copilot You are the **Vision Guardian Agent** (GOV-002). ' +
                'Analyze this epic and provide comprehensive constitutional review.\n\n' +
                '### Your Task:\n\n' +
                '1. Read Epic #' + epicNumber + '\n' +
                '2. Analyze against /main/Foundation.md, /docs/BRAND_STRATEGY.md\n' +
                '3. Identify gaps (business, technical, vision, risk)\n' +
                '4. Propose world-class solutions\n' +
                '5. Calculate alignment score (0-100)\n' +
                '6. Assign risk level (1-4)\n' +
                '7. Post comprehensive review\n\n' +
                '### Required Analysis:\n\n' +
                '- Constitutional alignment check\n' +
                '- Gap analysis with specific solutions\n' +
                '- Risk assessment\n' +
                '- Recommendation: Approve/Revise/Reject\n\n' +
                '---\n\n' +
                '## Epic Details\n\n' +
                epicBody + '\n\n' +
                '---\n\n' +
                '**Status**: Waiting for Vision Guardian analysis\n\n' +
                '**Instructions**: Vision Guardian will post review below. ' +
                'Governor reviews and comments decision.\n\n' +
                '**Related Epic**: #' + epicNumber;

              const review = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[VG REVIEW] Epic #' + epicNumber + ': ' + epicTitle,
                body: reviewBody,
                labels: ['vision-guardian-agent', 'vision-guardian-review', '#github-pull-request_copilot-coding-agent']
              });

              core.info(`Created Vision Guardian review issue #${review.data.number}`);

              // Comment on epic with link to review
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: epicNumber,
                body: `ðŸ›¡ï¸ **Vision Guardian Review Created**: #${review.data.number}\n\nPlease complete the constitutional review before proceeding with implementation.`
              });

            } else if (labels.includes('story')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['business-analyst-agent']
              });
              core.info('Story issue - assigned to Business Analyst Agent');
            } else if (labels.includes('task')) {
              const taskType = issue.body.match(/Task Type.*?\n.*?- \[(.*?)\]/s);
              if (taskType && taskType[1].includes('Infrastructure')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['deployment-agent']
                });
              } else if (taskType && taskType[1].includes('Testing')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['testing-agent']
                });
              } else {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['systems-architect-agent']
                });
              }
              core.info('Task issue - assigned based on task type');
            } else if (labels.includes('bug')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['testing-agent']
              });
              core.info('Bug issue - assigned to Testing Agent for triage');
            }

  move-to-in-progress:
    name: Move to In Progress
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'in-progress'
    steps:
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ðŸš€ **Status Update**: Issue moved to **In Progress**\n\nAgent working on implementation...'
            });

  move-to-review:
    name: Move to Review
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'in-review'
    steps:
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ðŸ‘€ **Status Update**: Issue moved to **Review**\n\nAwaiting validation and approval...'
            });

  move-to-done:
    name: Move to Done
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'closed'
    steps:
      - name: Add completion comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['done']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'âœ… **Status Update**: Issue moved to **Done**\n\nWork completed and closed.'
            });

  link-pr-to-issue:
    name: Link PR to Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Auto-link PR to issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            // Extract issue numbers from PR body (Closes #123, Fixes #456)
            const issuePattern = /(Closes|Fixes|Resolves)\s+#(\d+)/gi;
            const matches = [...prBody.matchAll(issuePattern)];

            if (matches.length > 0) {
              for (const match of matches) {
                const issueNumber = match[2];
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: `ðŸ”— **PR Linked**: #${pr.number} - ${pr.title}\n\nImplementation in progress...`
                });

                // Add in-review label to issue
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  labels: ['in-review']
                });
              }
            }

  auto-close-issue-on-pr-merge:
    name: Auto-Close Issue on PR Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            // Extract issue numbers from PR body
            const issuePattern = /(Closes|Fixes|Resolves)\s+#(\d+)/gi;
            const matches = [...prBody.matchAll(issuePattern)];

            if (matches.length > 0) {
              for (const match of matches) {
                const issueNumber = match[2];

                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  state: 'closed'
                });

                // Add completion comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: `âœ… **Closed via PR**: #${pr.number}\n\n**Merged by**: @${pr.merged_by.login}\n**Deployed**: Changes will be deployed in next release.`
                });
              }
            }

  vg-approval-handler:
    name: VG Approval Handler
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      contains(github.event.issue.labels.*.name, 'vision-guardian-review')
    permissions:
      issues: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Handle Governor Decision
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase().trim();
            const reviewIssue = context.payload.issue;
            const issueBody = reviewIssue.body || '';
            const epicMatch = issueBody.match(/\*\*Epic\*\*:\s+#(\d+)/);
            if (!epicMatch) {
              core.info('No epic reference found');
              return;
            }
            const epicNumber = epicMatch[1];
            const epic = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(epicNumber)
            });
            const epicTitle = epic.data.title;
            const branchSlug = epicTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').substring(0, 50);
            const branchName = 'epic-' + epicNumber + '-' + branchSlug;
            if (comment === 'approve' || comment.startsWith('approve')) {
              core.info('Governor approved epic');
              const defaultBranch = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              const mainRef = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/' + defaultBranch.data.default_branch
              });
              try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'refs/heads/' + branchName,
                  sha: mainRef.data.object.sha
                });
              } catch (error) {
                if (error.status !== 422) throw error;
              }
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(epicNumber),
                body: 'âœ… **Vision Guardian Approved**\n\nBranch: `' + branchName + '`\n\nSystems Architect notified.'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: reviewIssue.number,
                state: 'closed'
              });
            } else if (comment === 'reject' || comment.startsWith('reject')) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(epicNumber),
                state: 'closed'
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: reviewIssue.number,
                state: 'closed'
              });
            }
