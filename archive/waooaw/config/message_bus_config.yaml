# Message Bus Configuration
# Controls behavior of Redis Streams-based message infrastructure

message_bus:
  # Priority Streams Configuration
  priority_streams:
    - name: "messages:p5"
      priority: 5
      description: "Critical (system alerts, failures, shutdown signals)"
      max_length: 10000
      approximate_trim: true
      
    - name: "messages:p4"
      priority: 4
      description: "High (time-sensitive work, customer-facing tasks)"
      max_length: 50000
      approximate_trim: true
      
    - name: "messages:p3"
      priority: 3
      description: "Normal (default priority, most agent communication)"
      max_length: 100000
      approximate_trim: true
      
    - name: "messages:p2"
      priority: 2
      description: "Low (background tasks, non-urgent processing)"
      max_length: 100000
      approximate_trim: true
      
    - name: "messages:p1"
      priority: 1
      description: "Bulk (analytics, logs, batch operations)"
      max_length: 50000
      approximate_trim: true
  
  # Consumer Group Settings
  consumer_groups:
    default_read_count: 10          # Messages to fetch per XREADGROUP
    block_time_ms: 5000             # Max time to block waiting for messages
    claim_idle_time_ms: 60000       # Claim messages idle for > 1 minute
    claim_max_messages: 100         # Max messages to claim at once
    pending_check_interval_ms: 30000 # Check for pending messages every 30s
  
  # Dead Letter Queue Configuration
  dlq:
    stream_name: "messages:dlq"
    max_retries: 3                  # Retries before moving to DLQ
    alert_threshold: 10             # Alert ops if DLQ depth > this
    retention_days: 365             # Keep DLQ messages for 1 year
    max_length: 100000
  
  # Audit Trail Configuration
  audit:
    enabled: true
    table_name: "message_audit"
    batch_size: 100                 # Batch inserts for performance
    flush_interval_seconds: 60      # Flush every minute even if batch not full
    retention_years: 7              # Compliance requirement
    
  # Retry Strategy
  retry:
    max_attempts: 3
    backoff_strategy: "exponential"  # exponential or linear
    initial_delay_seconds: 1
    max_delay_seconds: 60
    multiplier: 2                   # For exponential backoff
  
  # Message Limits
  limits:
    max_message_size_bytes: 1048576  # 1 MB max message size
    max_payload_depth: 10            # Max nested object depth
    max_array_length: 1000           # Max array elements
    max_string_length: 65535         # Max string field length (64 KB)
  
  # Timeouts
  timeouts:
    send_timeout_seconds: 5
    receive_timeout_seconds: 30
    ack_timeout_seconds: 10
  
  # Schema Validation
  schema:
    enabled: true
    strict_mode: true               # Reject extra fields not in schema
    schema_dir: "waooaw/messaging/schemas"
    
  # Security
  security:
    signature_required: true
    signature_algorithm: "hmac-sha256"
    signature_field: "signature"
    validate_timestamp: false       # Future: prevent replay attacks
    max_message_age_seconds: 300    # For timestamp validation (future)
