{#
  Cloud Run Service Template
  Creates a fully configured Cloud Run service with NEG for Load Balancer
#}

{% set project = env["project"] %}
{% set deployment = env["deployment"] %}
{% set name = properties["name"] %}
{% set region = properties["region"] %}

resources:
  # Cloud Run Service (v2 API)
  - name: {{ name }}
    type: gcp-types/run-v2:projects.locations.services
    properties:
      location: {{ region }}
      serviceId: {{ name }}
      labels:
        environment: {{ properties["environment"] }}
        service: {{ properties["serviceType"] }}
        managed-by: deployment-manager
      template:
        serviceAccount: {{ properties["serviceAccount"] }}
        executionEnvironment: EXECUTION_ENVIRONMENT_GEN2
        timeout: "{{ properties["timeout"] }}s"
        scaling:
          minInstanceCount: {{ properties["scaling"]["minInstances"] }}
          maxInstanceCount: {{ properties["scaling"]["maxInstances"] }}
        maxInstanceRequestConcurrency: {{ properties["scaling"]["concurrency"] }}
        annotations:
          run.googleapis.com/cpu-throttling: "{{ properties["scaling"]["cpuThrottling"]|lower }}"
        containers:
          - image: {{ properties["container"]["image"] }}
            ports:
              - containerPort: {{ properties["container"]["port"] }}
            resources:
              limits:
                cpu: "{{ properties["resources"]["cpu"] }}"
                memory: {{ properties["resources"]["memory"] }}
            env:
              {% for env in properties["envVars"] %}
              - name: {{ env["name"] }}
                value: "{{ env["value"] }}"
              {% endfor %}
              {% for secret in properties["secrets"] %}
              - name: {{ secret["name"] }}
                valueSource:
                  secretKeyRef:
                    secret: {{ secret["secretName"] }}
                    version: latest
              {% endfor %}
      traffic:
        - type: TRAFFIC_TARGET_ALLOCATION_TYPE_LATEST
          percent: 100
    metadata:
      dependsOn: []

  # Network Endpoint Group (for Load Balancer)
  - name: {{ name }}-neg
    type: compute.beta.regionNetworkEndpointGroup
    properties:
      name: {{ name }}-neg
      region: {{ region }}
      networkEndpointType: SERVERLESS
      cloudRun:
        service: {{ name }}
    metadata:
      dependsOn:
        - {{ name }}

outputs:
  - name: serviceName
    value: {{ name }}
  - name: negName
    value: {{ name }}-neg
  - name: region
    value: {{ region }}
  - name: serviceUrl
    value: $(ref.{{ name }}.status.url)
