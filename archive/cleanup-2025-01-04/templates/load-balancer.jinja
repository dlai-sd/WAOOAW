{#
  Load Balancer Template
  Creates complete HTTPS Load Balancer with SSL, URL map, backend services
  Supports multi-domain routing (customer portal + platform portal)
#}

{% set project = env["project"] %}
{% set deployment = env["deployment"] %}
{% set environment = properties["environment"] %}
{% set domains = properties["domains"] %}

resources:
  # Backend Service - API (shared by both portals)
  - name: {{ environment }}-api-backend-service
    type: compute.v1.backendService
    properties:
      name: {{ environment }}-api-backend-service
      description: Backend service for API (shared by both portals)
      protocol: HTTPS
      portName: http
      timeoutSec: 30
      backends:
        {% for backend in properties["backends"]["api"] %}
        - group: $(ref.{{ backend["serviceName"] }}-neg.selfLink)
          balancingMode: UTILIZATION
          maxRatePerInstance: {{ backend["maxRate"] }}
          capacityScaler: {{ backend["capacityScaler"] }}
        {% endfor %}
      healthChecks:
        - $(ref.{{ environment }}-api-health-check.selfLink)
      logConfig:
        enable: true
        sampleRate: {{ properties["logSampleRate"] }}

  # Backend Service - Customer Portal
  - name: {{ environment }}-customer-backend-service
    type: compute.v1.backendService
    properties:
      name: {{ environment }}-customer-backend-service
      description: Backend service for Customer Portal (Marketplace)
      protocol: HTTPS
      portName: http
      timeoutSec: 30
      backends:
        {% for backend in properties["backends"]["customer"] %}
        - group: $(ref.{{ backend["serviceName"] }}-neg.selfLink)
          balancingMode: UTILIZATION
          maxRatePerInstance: {{ backend["maxRate"] }}
          capacityScaler: {{ backend["capacityScaler"] }}
        {% endfor %}
      healthChecks:
        - $(ref.{{ environment }}-customer-health-check.selfLink)
      logConfig:
        enable: true
        sampleRate: {{ properties["logSampleRate"] }}

  # Backend Service - Platform Portal
  - name: {{ environment }}-platform-backend-service
    type: compute.v1.backendService
    properties:
      name: {{ environment }}-platform-backend-service
      description: Backend service for Platform Portal (Internal Ops)
      protocol: HTTPS
      portName: http
      timeoutSec: 30
      backends:
        {% for backend in properties["backends"]["platform"] %}
        - group: $(ref.{{ backend["serviceName"] }}-neg.selfLink)
          balancingMode: UTILIZATION
          maxRatePerInstance: {{ backend["maxRate"] }}
          capacityScaler: {{ backend["capacityScaler"] }}
        {% endfor %}
      healthChecks:
        - $(ref.{{ environment }}-platform-health-check.selfLink)
      logConfig:
        enable: true
        sampleRate: {{ properties["logSampleRate"] }}

  # Health Check - API
  - name: {{ environment }}-api-health-check
    type: compute.v1.healthCheck
    properties:
      name: {{ environment }}-api-health-check
      type: HTTPS
      httpsHealthCheck:
        port: 443
        requestPath: /health
      checkIntervalSec: {{ properties["healthCheck"]["interval"] }}
      timeoutSec: {{ properties["healthCheck"]["timeout"] }}
      healthyThreshold: {{ properties["healthCheck"]["healthyThreshold"] }}
      unhealthyThreshold: {{ properties["healthCheck"]["unhealthyThreshold"] }}

  # Health Check - Customer Portal
  - name: {{ environment }}-customer-health-check
    type: compute.v1.healthCheck
    properties:
      name: {{ environment }}-customer-health-check
      type: HTTPS
      httpsHealthCheck:
        port: 443
        requestPath: /
      checkIntervalSec: {{ properties["healthCheck"]["interval"] }}
      timeoutSec: {{ properties["healthCheck"]["timeout"] }}
      healthyThreshold: {{ properties["healthCheck"]["healthyThreshold"] }}
      unhealthyThreshold: {{ properties["healthCheck"]["unhealthyThreshold"] }}

  # Health Check - Platform Portal
  - name: {{ environment }}-platform-health-check
    type: compute.v1.healthCheck
    properties:
      name: {{ environment }}-platform-health-check
      type: HTTPS
      httpsHealthCheck:
        port: 443
        requestPath: /
      checkIntervalSec: {{ properties["healthCheck"]["interval"] }}
      timeoutSec: {{ properties["healthCheck"]["timeout"] }}
      healthyThreshold: {{ properties["healthCheck"]["healthyThreshold"] }}
      unhealthyThreshold: {{ properties["healthCheck"]["unhealthyThreshold"] }}

  # URL Map - HTTPS (Multi-domain routing)
  - name: {{ environment }}-url-map
    type: compute.v1.urlMap
    properties:
      name: {{ environment }}-url-map
      description: URL map for {{ environment }} - customer and platform portals
      defaultService: $(ref.{{ environment }}-customer-backend-service.selfLink)
      hostRules:
        # Customer Portal domain
        - hosts:
            - {{ domains["customer_portal"] }}
          pathMatcher: {{ environment }}-customer-matcher
        # Platform Portal domain
        - hosts:
            - {{ domains["platform_portal"] }}
          pathMatcher: {{ environment }}-platform-matcher
      pathMatchers:
        # Customer Portal routes
        - name: {{ environment }}-customer-matcher
          defaultService: $(ref.{{ environment }}-customer-backend-service.selfLink)
          pathRules:
            - paths:
                - /api/*
                - /auth/*
                - /health
              service: $(ref.{{ environment }}-api-backend-service.selfLink)
        # Platform Portal routes
        - name: {{ environment }}-platform-matcher
          defaultService: $(ref.{{ environment }}-platform-backend-service.selfLink)
          pathRules:
            - paths:
                - /api/*
                - /auth/*
                - /health
              service: $(ref.{{ environment }}-api-backend-service.selfLink)
    metadata:
      dependsOn:
        - {{ environment }}-api-backend-service
        - {{ environment }}-customer-backend-service
        - {{ environment }}-platform-backend-service

  # URL Map - HTTP Redirect to HTTPS
  - name: {{ environment }}-http-redirect-map
    type: compute.v1.urlMap
    properties:
      name: {{ environment }}-http-redirect-map
      defaultUrlRedirect:
        httpsRedirect: true
        redirectResponseCode: MOVED_PERMANENTLY_DEFAULT

  # SSL Certificates (Google-managed) - One per domain
  - name: {{ environment }}-customer-ssl-cert
    type: compute.v1.sslCertificate
    properties:
      name: {{ environment }}-customer-ssl-cert
      description: Managed SSL for {{ domains["customer_portal"] }}
      type: MANAGED
      managed:
        domains:
          - {{ domains["customer_portal"] }}

  - name: {{ environment }}-platform-ssl-cert
    type: compute.v1.sslCertificate
    properties:
      name: {{ environment }}-platform-ssl-cert
      description: Managed SSL for {{ domains["platform_portal"] }}
      type: MANAGED
      managed:
        domains:
          - {{ domains["platform_portal"] }}

  # Target HTTPS Proxy
  - name: {{ environment }}-https-proxy
    type: compute.v1.targetHttpsProxy
    properties:
      name: {{ environment }}-https-proxy
      urlMap: $(ref.{{ environment }}-url-map.selfLink)
      sslCertificates:
        - $(ref.{{ environment }}-customer-ssl-cert.selfLink)
        - $(ref.{{ environment }}-platform-ssl-cert.selfLink)
      quicOverride: ENABLE
    metadata:
      dependsOn:
        - {{ environment }}-url-map
        - {{ environment }}-customer-ssl-cert
        - {{ environment }}-platform-ssl-cert

  # Target HTTP Proxy (for redirect)
  - name: {{ environment }}-http-proxy
    type: compute.v1.targetHttpProxy
    properties:
      name: {{ environment }}-http-proxy
      urlMap: $(ref.{{ environment }}-http-redirect-map.selfLink)
    metadata:
      dependsOn:
        - {{ environment }}-http-redirect-map

  # Global Forwarding Rule - HTTPS
  - name: {{ environment }}-https-forwarding-rule
    type: compute.v1.globalForwardingRule
    properties:
      name: {{ environment }}-https-forwarding-rule
      description: HTTPS forwarding rule for {{ environment }}
      IPAddress: {% if properties.get("staticIpAddress") %}{{ properties["staticIpAddress"] }}{% else %}$(ref.{{ properties["staticIpName"] }}.address){% endif %}
      IPProtocol: TCP
      portRange: 443
      target: $(ref.{{ environment }}-https-proxy.selfLink)
      loadBalancingScheme: EXTERNAL_MANAGED
    metadata:
      dependsOn:
        - {{ environment }}-https-proxy

  # Global Forwarding Rule - HTTP
  - name: {{ environment }}-http-forwarding-rule
    type: compute.v1.globalForwardingRule
    properties:
      name: {{ environment }}-http-forwarding-rule
      description: HTTP forwarding rule for {{ environment }}
      IPAddress: {% if properties.get("staticIpAddress") %}{{ properties["staticIpAddress"] }}{% else %}$(ref.{{ properties["staticIpName"] }}.address){% endif %}
      IPProtocol: TCP
      portRange: 80
      target: $(ref.{{ environment }}-http-proxy.selfLink)
      loadBalancingScheme: EXTERNAL_MANAGED
    metadata:
      dependsOn:
        - {{ environment }}-http-proxy

outputs:
  - name: loadBalancerIp
    value: {% if properties.get("staticIpAddress") %}{{ properties["staticIpAddress"] }}{% else %}$(ref.{{ properties["staticIpName"] }}.address){% endif %}
  - name: customerDomain
    value: {{ domains["customer_portal"] }}
  - name: platformDomain
    value: {{ domains["platform_portal"] }}
  - name: customerSslStatus
    value: $(ref.{{ environment }}-customer-ssl-cert.managed.status)
  - name: platformSslStatus
    value: $(ref.{{ environment }}-platform-ssl-cert.managed.status)
