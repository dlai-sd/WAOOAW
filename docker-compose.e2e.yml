version: '3.8'

services:
  # PostgreSQL for gateway state
  postgres-e2e:
    image: postgres:15-alpine
    container_name: waooaw-postgres-e2e
    environment:
      POSTGRES_DB: gateway_e2e
      POSTGRES_USER: gateway
      POSTGRES_PASSWORD: gateway_password
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gateway -d gateway_e2e"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network

  # Redis for caching and rate limiting
  redis-e2e:
    image: redis:7-alpine
    container_name: waooaw-redis-e2e
    ports:
      - "6381:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - e2e-network

  # OPA for policy enforcement
  opa-e2e:
    image: openpolicyagent/opa:latest
    container_name: waooaw-opa-e2e
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
    ports:
      - "8182:8181"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8181/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - e2e-network

  # Mock Plant Service
  mock-plant:
    build:
      context: .
      dockerfile: Dockerfile.mock-plant
    container_name: waooaw-mock-plant
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8001/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - e2e-network

  # API Gateway (full stack)
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: waooaw-gateway-e2e
    environment:
      # Database
      DATABASE_URL: postgresql://gateway:gateway_password@postgres-e2e:5432/gateway_e2e
      
      # Redis
      REDIS_URL: redis://redis-e2e:6379/0
      
      # OPA
      OPA_URL: http://opa-e2e:8181
      
      # Plant Service
      PLANT_URL: http://mock-plant:8001
      
      # JWT
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      JWT_ALGORITHM: RS256
      
      # Budget
      DEFAULT_BUDGET_LIMIT: 1000
      BUDGET_WINDOW: 3600
      
      # Rate Limiting
      RATE_LIMIT_REQUESTS: 10
      RATE_LIMIT_WINDOW: 60
      
      # Feature Flags
      FEATURE_FLAG_TRIAL_MODE: true
      FEATURE_FLAG_GOVERNOR_APPROVAL: true
      
    ports:
      - "8000:8000"
    depends_on:
      postgres-e2e:
        condition: service_healthy
      redis-e2e:
        condition: service_healthy
      opa-e2e:
        condition: service_healthy
      mock-plant:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - e2e-network

networks:
  e2e-network:
    driver: bridge
