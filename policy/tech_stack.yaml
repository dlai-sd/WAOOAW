# WAOOAW Technology Stack Policy - Machine-Readable Specification
# This is the single source of truth for architecture enforcement
# Changes require approval as per Section 12.2 of TECH_STACK_SELECTION_POLICY.md

metadata:
  version: "2.0"
  last_updated: "2026-01-07"
  session: "Session 3 - Microservices Architecture"
  enforcement_level: mandatory
  
  # Lineage: What documents define this policy
  source_documents:
    - path: policy/TECH_STACK_SELECTION_POLICY.md
      sections: [7, 8, 9]
      version: "2.0"
    - path: main/Foundation/TOOLING_SELECTION_DECISION.md
      sections: [11]
      version: "2.0"
    - path: main/run_log.md
      session: "Session 3 Phase 4"
  
  # Traceability: What references this file
  referenced_by:
    - README.md
    - main/Foundation.md
    - scripts/audit_tech_stack.py
    - .github/workflows/architecture-compliance.yml
  
  # Audit
  last_audit: null
  next_audit: "2026-02-03"
  audit_frequency: monthly

# ==============================================================================
# MICROSERVICES ARCHITECTURE (6 Approved Services)
# ==============================================================================

services:
  approved:
    - name: agent-creation
      purpose: "Agent lifecycle (Genesis→Architect→Guardian→Governor workflow), agent registry writes, Temporal saga orchestration"
      port: 8001
      owner: platform
      tech_stack:
        language: python-3.11
        framework: fastapi
        orchestration: temporal
        database_schema: agents
      bounded_context: "Agent Creation"
      constitutional_layer: ["L1-Structure", "L2-Operations"]
      
    - name: agent-execution
      purpose: "Customer work execution, Manager orchestration, specialist coordination, job completion, seed draft extraction"
      port: 8002
      owner: platform
      tech_stack:
        language: python-3.11
        framework: fastapi
        ml_models: [bart-base, distilbert, prophet]
      bounded_context: "Agent Execution"
      constitutional_layer: ["L2-Operations"]
      
    - name: governance
      purpose: "Governor approvals, mobile notifications, veto workflows, constitutional compliance, approval audit trail"
      port: 8003
      owner: governance
      tech_stack:
        language: python-3.11
        framework: fastapi
        ml_models: [logistic-regression]
      bounded_context: "Governance"
      constitutional_layer: ["L1-Structure", "L2-Operations"]
      
    - name: industry-knowledge
      purpose: "Vector DB operations, embeddings generation, industry corpus management, cache updates, query routing"
      port: 8004
      owner: data
      tech_stack:
        language: python-3.11
        framework: fastapi
        vector_db: [chroma, qdrant]
        ml_models: [all-minilm-l6-v2]
        external_apis: [openai]
      bounded_context: "Industry Knowledge"
      constitutional_layer: ["L2-Operations"]
      database_schema: industry_embeddings
      
    - name: learning
      purpose: "Precedent Seed lifecycle, Genesis review workflows, seed approval, feedback loop orchestration"
      port: 8005
      owner: ai-ml
      tech_stack:
        language: python-3.11
        framework: fastapi
        orchestration: temporal
      bounded_context: "Learning"
      constitutional_layer: ["L3-Learning"]
      database_schema: seeds
      
    - name: admin-gateway
      purpose: "Admin operations aggregation, conversational admin interface, cross-service coordination, metrics dashboard"
      port: 8006
      owner: operations
      tech_stack:
        language: python-3.11
        framework: fastapi
        ml_models: [phi-3-mini]
      bounded_context: "Admin Gateway (BFF)"
      constitutional_layer: ["L2-Operations"]
  
  deviation_rules:
    - rule: no_new_services_without_approval
      check: "Count services in services/ directory, alert if > 6"
      severity: critical
      
    - rule: no_direct_service_calls
      check: "Scan for requests.get/post to :800[1-6] ports, must use Temporal or Pub/Sub"
      severity: critical
      
    - rule: port_assignment_enforced
      check: "Each service uses assigned port only"
      severity: high

# ==============================================================================
# TECHNOLOGY STACK (Approved Languages, Frameworks, Infrastructure)
# ==============================================================================

tech_stack:
  languages:
    approved:
      - name: python
        version: "3.11+"
        purpose: "Primary language for all services, agent runtime, orchestration"
        
  backend_frameworks:
    approved:
      - name: fastapi
        purpose: "API services, microservices endpoints, async support"
        
  frontend_frameworks:
    approved:
      - name: react
        version: "18+"
        purpose: "Customer portal, operations portal (consolidation from Reflex)"
        
      - name: reflex
        status: deprecated
        migration_target: react
        migration_deadline: "Phase 4"
        
  orchestration:
    approved:
      - name: temporal
        deployment: self-hosted-cloud-run
        cost_monthly: 15
        purpose: "Durable workflows (Agent Creation, Seed Review), saga pattern, 24-hour Governor veto windows"
        
  workflow_engines:
    approved:
      - name: python-business-rules
        cost_monthly: 0
        purpose: "Decision tables (query routing, budget thresholds, seed matching)"
        
    prohibited:
      - name: camunda
        reason: "3-5x cost vs Temporal, Java-based not Python-native"
        
      - name: jbpm
        reason: "Enterprise BPMN complexity exceeds constitutional needs"

  databases:
    approved:
      - name: postgresql
        deployment: cloud-sql
        cost_monthly: 20
        purpose: "Shared governance/agents/seeds schemas (ACID critical), separate industry_embeddings schema"
        schemas: [governance, agents, seeds, audit_log, industry_embeddings, vector_cache]
        connection_pooler: pgbouncer
        
      - name: redis
        deployment: memorystore
        cost_monthly: 10
        purpose: "L2 cache (5-min TTL), event idempotency (24-hour), connection queue buffers"
        
      - name: chroma
        deployment: self-hosted-cloud-run
        cost_monthly: 5
        purpose: "Vector database (development)"
        
      - name: qdrant
        deployment: self-hosted-cloud-run
        cost_monthly: 10
        purpose: "Vector database (production)"

  messaging:
    approved:
      - name: cloud-pub-sub
        cost_monthly: 5-10
        purpose: "Asynchronous events (AgentStateChanged, SeedApproved, GovernorVetoed, EmbeddingsUpdated, IndustryAdded, JobCompleted)"

  infrastructure:
    approved:
      - name: cloud-run
        purpose: "Serverless container deployment, autoscale to zero"
        
      - name: gcp
        purpose: "Primary cloud provider"
        
      - name: docker
        purpose: "Container images for services"

# ==============================================================================
# ML MODELS REGISTRY (8 Approved Small/Medium CPU-Based Models)
# ==============================================================================

ml_models:
  approved:
    - name: distilbert
      size_mb: 66
      purpose: "Agent prediction (cache warming), ETA estimation (seed processing)"
      service: agent-execution
      inference_time_ms: 50-100
      cost_monthly: 0
      requires_gpu: false
      fallback: "Use 7-day average for predictions"
      
    - name: bart-base
      size_mb: 140
      purpose: "Seed summarization (extract precedent from job results)"
      service: agent-execution
      inference_time_ms: 100-200
      cost_monthly: 0
      requires_gpu: false
      fallback: "Skip summarization, use raw result"
      
    - name: all-minilm-l6-v2
      size_mb: 22
      purpose: "Semantic cache (query embedding similarity matching)"
      service: industry-knowledge
      inference_time_ms: 30-50
      cost_monthly: 0
      requires_gpu: false
      fallback: "Use exact string match cache"
      
    - name: phi-3-mini
      size_mb: 1024
      quantization: 4-bit
      purpose: "Conversational admin (natural language → API calls)"
      service: admin-gateway
      inference_time_ms: 150-300
      cost_monthly: 0
      requires_gpu: false
      fallback: "Show command palette instead of NLU"
      
    - name: prophet
      size_mb: 10
      purpose: "Time-series prediction (load forecasting, cache warming)"
      service: agent-execution
      inference_time_ms: 50
      cost_monthly: 0
      requires_gpu: false
      training_frequency: daily
      fallback: "Use 7-day moving average"
      
    - name: logistic-regression
      size_mb: 1
      purpose: "Notification channel routing (predict Governor response time)"
      service: governance
      inference_time_ms: 5
      cost_monthly: 0
      requires_gpu: false
      training_frequency: daily
      fallback: "Default to push notification"
      
    - name: lstm-tiny
      size_mb: 5
      purpose: "Database connection load prediction"
      service: all
      inference_time_ms: 10
      cost_monthly: 0
      requires_gpu: false
      fallback: "Use static connection pool sizing"
  
  usage_constraints:
    - constraint: inference_in_service_process
      description: "Models run within service process, no separate ML service unless >5 models"
      
    - constraint: models_bundled_or_gcs
      description: "Models bundled in Docker image or loaded from GCS bucket at startup"
      
    - constraint: fallback_required
      description: "All ML predictions must have non-ML fallback, system functions with degraded UX if model fails"
  
  prohibited:
    - constraint: large_models
      threshold_mb: 2048
      reason: "Cloud Run 2GB RAM limit, would require GPU instances ($100+/month)"
      
    - constraint: sync_ml_in_request_path
      reason: "Only async background (seed extraction, cache warming) or <100ms inference (MiniLM, Logistic Regression)"
      exceptions: ["all-minilm-l6-v2", "logistic-regression"]
      
    - constraint: external_ml_apis_in_hot_path
      reason: "OpenAI embeddings only for admin operations (industry setup), not customer queries"
      allowed_apis: [openai-admin-only]

# ==============================================================================
# EVENT CATALOG (Cloud Pub/Sub Topics with Schemas)
# ==============================================================================

pub_sub_topics:
  topics:
    - name: AgentStateChanged
      publisher: agent-creation
      subscribers: [agent-execution, industry-knowledge, learning, governance, admin-gateway]
      schema:
        agent_id: string
        old_state: string
        new_state: string
        timestamp: iso8601
        causation_id: string
        correlation_id: string
        vector_clock: object
      retention_days: 7
      
    - name: SeedApproved
      publisher: learning
      subscribers: [industry-knowledge, agent-execution, agent-creation]
      schema:
        seed_id: string
        correlation_id: string
        vector_clock: object
        approved_by: string
        timestamp: iso8601
      retention_days: 7
      
    - name: GovernorVetoed
      publisher: governance
      subscribers: [agent-creation, learning]
      schema:
        approval_id: string
        reason: string
        affected_entities: array
        timestamp: iso8601
        causation_id: string
      retention_days: 30
      
    - name: EmbeddingsUpdated
      publisher: industry-knowledge
      subscribers: [agent-execution, agent-creation]
      schema:
        industry: string
        version: string
        causation_id: string
        timestamp: iso8601
      retention_days: 7
      
    - name: IndustryAdded
      publisher: industry-knowledge
      subscribers: [agent-creation, agent-execution, governance, learning, admin-gateway]
      schema:
        industry_id: string
        name: string
        state: string
        embeddings_ready: boolean
        timestamp: iso8601
      retention_days: 30
      
    - name: JobCompleted
      publisher: agent-execution
      subscribers: [learning]
      schema:
        job_id: string
        result_summary: string
        customer_feedback: object
        timestamp: iso8601
        correlation_id: string
      retention_days: 7
  
  event_constraints:
    - constraint: causation_tracking_required
      fields: [causation_id, correlation_id]
      description: "All events must include causation_id (what triggered) and correlation_id (original request)"
      severity: critical
      
    - constraint: vector_clock_for_ordering
      description: "Events requiring ordering must include vector_clock {service_name: sequence_number}"
      applicable_to: [SeedApproved, AgentStateChanged]

# ==============================================================================
# ARCHITECTURAL PATTERNS (Enforced and Prohibited)
# ==============================================================================

patterns:
  enforced:
    - name: saga-pattern
      description: "Temporal workflows with compensation activities for rollbacks"
      implementation: "Agent Creation workflow: Genesis → Architect → Guardian → Governor with reverse compensations"
      
    - name: event-sourcing
      description: "Append-only audit_log table for constitutional traceability"
      implementation: "Events include causation_id, correlation_id, vector_clock; services track processed event IDs in Redis (24-hour TTL)"
      
    - name: multi-level-caching
      description: "L1 (local 1-min) → L2 (Redis 5-min) → L3 (source)"
      implementation: "Semantic cache using MiniLM embeddings (cosine >0.95 = cache hit)"
      
    - name: predictive-infrastructure
      description: "Prophet predicts load/queries 5-min ahead, LSTM predicts DB connections"
      implementation: "Pre-scale services, pre-warm cache, adjust PgBouncer pool"
      
    - name: circuit-breaker
      description: "Connection wait >2s → 503, downstream 429 → exponential backoff"
      implementation: "Auto-close after 30s, backoff sequence: 100ms → 200ms → 400ms"
      
    - name: feature-flags
      description: "Industry lifecycle state machine (draft → embeddings_generating → agents_pending → active → deprecated)"
      implementation: "Services check industry state before processing"
      
    - name: bff-pattern
      description: "Admin Gateway aggregates cross-service operations"
      implementation: "Single entry point for admin operations, prevents service bypass"
      
    - name: optimistic-ui
      description: "Show progress ('processing 2/3 services'), reconcile async via WebSocket"
      implementation: "Immediate feedback, backend reconciliation updates UI"
  
  prohibited:
    - name: two-phase-commit
      reason: "Use Temporal saga instead (more resilient, auditable)"
      severity: critical
      
    - name: distributed-transactions
      reason: "Use eventual consistency + compensating transactions"
      severity: critical
      
    - name: synchronous-cascading-calls
      threshold: 3
      reason: "Use Temporal orchestration or pub/sub, max 3 hops"
      severity: high
      
    - name: timestamp-based-ordering
      reason: "Use vector clocks for causal consistency"
      severity: high
      
    - name: polling-for-state-changes
      reason: "Use pub/sub events with polling fallback only (5-min reconciliation)"
      severity: medium
      
    - name: hardcoded-retry-logic
      reason: "Use Temporal built-in retry policies"
      severity: medium

# ==============================================================================
# COMMUNICATION PROTOCOLS
# ==============================================================================

communication:
  synchronous:
    protocol: rest
    format: json
    schema: openapi-3.1
    authentication: workload-identity-jwt
    
    constraints:
      - constraint: orchestrated_by_temporal
        description: "Service-to-service REST calls must be orchestrated by Temporal workflows"
        examples: ["Agent Creation → Genesis activity", "Manager → Specialist calls"]
        
      - constraint: no_grpc_without_proof
        description: "gRPC prohibited unless proven REST bottleneck (>10K RPS)"
        requires_benchmark: true
  
  asynchronous:
    protocol: pub-sub
    platform: cloud-pub-sub
    
    use_cases:
      - "Broadcast events (AgentStateChanged, SeedApproved, GovernorVetoed)"
      - "State change notifications (EmbeddingsUpdated, IndustryAdded)"
      - "Background processing triggers (JobCompleted)"

# ==============================================================================
# DATA MANAGEMENT
# ==============================================================================

data_management:
  shared_postgresql:
    schemas: [governance, agents, seeds, audit_log]
    purpose: "ACID critical for constitutional operations"
    connection_pooler:
      tool: pgbouncer
      real_connections: 100
      virtual_connections: 1000
      per_service_limits:
        agent-execution: 40
        industry-knowledge: 20
        agent-creation: 15
        governance: 10
        learning: 10
        admin-gateway: 5
  
  separate_postgresql:
    schemas: [industry_embeddings, vector_cache]
    purpose: "Vector operations, separate scaling"
    service: industry-knowledge
  
  redis:
    purpose: "L2 cache, event idempotency, connection queue buffers"
    ttl:
      l2_cache_minutes: 5
      idempotency_hours: 24
  
  vector_database:
    dev: chroma
    prod: qdrant
    deployment: self-hosted-cloud-run

# ==============================================================================
# DEVIATION DETECTION RULES (Automated Enforcement)
# ==============================================================================

deviation_rules:
  - id: DR-001
    rule: no_shared_database_tables
    check: "Scan SQLAlchemy models, ensure tables belong to single schema per service"
    exceptions: [governance, agents, seeds]
    severity: critical
    auto_fix: false
    
  - id: DR-002
    rule: events_have_causation_tracking
    check: "Scan Pub/Sub publish calls, ensure causation_id and correlation_id present"
    severity: critical
    auto_fix: false
    
  - id: DR-003
    rule: cache_has_invalidation
    check: "Scan Redis cache usage, ensure Pub/Sub subscription for invalidation"
    severity: high
    auto_fix: false
    
  - id: DR-004
    rule: admin_operations_via_gateway
    check: "Scan for admin endpoints outside admin-gateway service"
    severity: high
    auto_fix: false
    
  - id: DR-005
    rule: ml_model_has_fallback
    check: "Scan ML model inference code, ensure try/except with fallback logic"
    severity: high
    auto_fix: false
    
  - id: DR-006
    rule: no_large_ml_models
    check: "Scan requirements.txt and Docker images, flag models >2GB"
    severity: critical
    auto_fix: false
    
  - id: DR-007
    rule: sync_chains_max_3_hops
    check: "Trace request flows, detect synchronous chains >3 hops"
    severity: high
    auto_fix: false
    
  - id: DR-008
    rule: openapi_schema_compliance
    check: "Validate all FastAPI routes have OpenAPI 3.1 schemas"
    severity: medium
    auto_fix: true
    auto_fix_action: "Generate schema from type hints"

# ==============================================================================
# COST BUDGET
# ==============================================================================

cost_budget:
  total_monthly_target: 120
  total_monthly_max: 150
  
  breakdown:
    fixed:
      postgresql: 20
      redis: 10
      temporal: 15
      vector_db_storage: 5
      total: 50
      
    variable:
      agent_creation: 10-15
      agent_execution: 15-25
      governance: 5-10
      industry_knowledge: 10-20
      learning: 5-10
      admin_gateway: 10-15
      pub_sub: 5-10
      pgbouncer: 5
      sms_notifications: 5
      total: 70-95
  
  alerts:
    - threshold_percent: 80
      action: "Email platform team"
    - threshold_percent: 100
      action: "Slack alert + auto-scale review"
    - threshold_percent: 120
      action: "Emergency governor meeting"

# ==============================================================================
# AUDIT & COMPLIANCE
# ==============================================================================

audit:
  frequency: monthly
  next_audit: "2026-02-03"
  
  checks:
    - check: service_count_equals_6
      command: "ls -1 services/ | wc -l"
      expected: 6
      
    - check: no_unapproved_dependencies
      command: "scripts/audit_tech_stack.py --check dependencies"
      
    - check: all_events_have_causation
      command: "scripts/audit_tech_stack.py --check event-schemas"
      
    - check: cost_within_budget
      command: "gcloud billing --format=json | jq '.cost' | scripts/check_budget.py"
      
    - check: openapi_schemas_valid
      command: "scripts/audit_tech_stack.py --check openapi"
      
    - check: ml_models_cpu_only
      command: "scripts/audit_tech_stack.py --check ml-models"
  
  reporting:
    format: markdown
    output: docs/compliance/audit_report_YYYY-MM-DD.md
    notify: [platform-team, cto]

# ==============================================================================
# VERSION HISTORY
# ==============================================================================

version_history:
  - version: "2.0"
    date: "2026-01-07"
    session: "Session 3"
    changes:
      - "Added 6 microservices architecture"
      - "Added 8 ML models registry"
      - "Added 6 Pub/Sub topics with schemas"
      - "Added 8 architectural patterns (enforced)"
      - "Added 6 anti-patterns (prohibited)"
      - "Added 8 deviation detection rules"
      - "Added cost budget breakdown"
    approved_by: "Platform Governor"
    
  - version: "1.3"
    date: "2026-01-07"
    session: "Session 2"
    changes:
      - "Added Temporal workflow orchestration"
      - "Added Python business-rules engine"
      - "Prohibited Camunda/jBPM"
    approved_by: "Platform Governor"

# ==============================================================================
# REFERENCES (Traceability Chain)
# ==============================================================================

references:
  constitutional_design:
    - path: main/Foundation.md
      sections: ["L0-Principles", "L1-Structure", "L2-Operations", "L3-Learning"]
      
  policy_documents:
    - path: policy/TECH_STACK_SELECTION_POLICY.md
      version: "2.0"
      
    - path: main/Foundation/TOOLING_SELECTION_DECISION.md
      version: "2.0"
      
  implementation_guides:
    - path: main/run_log.md
      session: "Session 3"
      
  audit_tools:
    - path: scripts/audit_tech_stack.py
      
  ci_cd:
    - path: .github/workflows/architecture-compliance.yml

# ==============================================================================
# END OF TECH STACK SPECIFICATION
# ==============================================================================
