component: "system_audit_account"
component_version: "1.0"
component_type: "foundational_platform_component"

purpose: "Privileged bootstrap account that breaks the audit circular dependency by logging all governance actions without itself requiring governance approval"

constitutional_status:
  classification: "foundational_platform_component"
  authority: "foundation_constitution_engine"
  oversight: "vision_guardian_foundational_governance_agent"
  note: "SYSTEM_AUDIT is the ONLY account with governance exemption - required to make constitutional governance possible"

problem_statement:
  circular_dependency:
    description: "Agent needs data access â†’ requires approval â†’ requires audit logging. Audit system needs data access â†’ requires approval â†’ requires audit logging of the auditor. Infinite loop."
    
  solution:
    description: "Create privileged SYSTEM_AUDIT account that can write audit logs WITHOUT requiring approval. This breaks the loop."
    
  constitutional_rationale:
    - "Without audit logging, no agent can execute (constitutional requirement)"
    - "Without audit account exemption, audit logging cannot function"
    - "Therefore, audit account exemption is constitutionally necessary"

identity:
  account_id: "SYSTEM_AUDIT"
  account_type: "privileged_bootstrap_account"
  authority: "foundation_constitution_engine"
  immutable: true
  cannot_be_deleted: true
  cannot_be_suspended: true

privileges:
  write_audit_log:
    scope: "unrestricted"
    approval_required: false
    rationale: "Bootstrap privilege - required to make governance possible"
  
  read_agent_actions:
    scope: "unrestricted"
    approval_required: false
    rationale: "Must read all agent actions to audit them"
  
  write_observability_metrics:
    scope: "unrestricted"
    approval_required: false
    rationale: "Performance metrics are derived from audit logs"
  
  read_governance_decisions:
    scope: "unrestricted"
    approval_required: false
    rationale: "Must audit governance agent decisions"

constraints:
  strict_limitations:
    can_only_write_audit_data: true
    cannot_read_customer_data: true
    cannot_read_business_data: true
    cannot_execute_business_logic: true
    cannot_modify_agents: true
    cannot_modify_governance_rules: true
    cannot_approve_or_deny_requests: true
    cannot_communicate_with_agents: true
  
  purpose_limitation:
    description: "SYSTEM_AUDIT has ONE purpose: write audit logs. Nothing else."
    enforcement: "code_level_restrictions + vision_guardian_monitoring"

governance_exemption:
  exemption_scope:
    approval_required: false
    audit_itself: false
    scope_validation: false
    rate_limiting: false
  
  rationale:
    - "If SYSTEM_AUDIT required approval, who approves? Infinite loop."
    - "If SYSTEM_AUDIT audits itself, infinite log entries."
    - "Therefore, SYSTEM_AUDIT must be exempt from standard governance."
  
  oversight_mechanism:
    - vision_guardian_monitors_system_audit_behavior
    - systems_architect_monitors_system_audit_performance
    - any_deviation_from_purpose_triggers_constitutional_crisis
  
  constitutional_crisis_definition:
    triggers:
      - system_audit_attempts_to_read_customer_data
      - system_audit_attempts_to_modify_agents
      - system_audit_attempts_to_execute_business_logic
      - system_audit_account_credentials_compromised
    
    response:
      step_1: "immediate_system_wide_suspension"
      step_2: "vision_guardian_notified"
      step_3: "platform_governor_notified"
      step_4: "forensic_investigation"
      step_5: "restore_from_backup_or_rebuild"

audit_log_structure:
  component: "component_audit_logging_requirements.yml"
  
  log_entry_schema:
    - timestamp (ISO8601 with microsecond precision)
    - event_id (UUID)
    - event_type (action | approval | escalation | data_access | communication | etc)
    - actor_id (who performed the action)
    - actor_type (agent | foundational_governance_agent | governor | system)
    - action_performed (string)
    - target_id (what was acted upon)
    - target_type (customer | agent | integration | etc)
    - context (JSON object with additional details)
    - approval_chain (if applicable)
    - result (success | failure)
    - error_details (if failed)
    - immutability_proof (cryptographic hash)
  
  write_mechanism:
    - append_only (no updates or deletes)
    - cryptographic_hash_chain (each entry hashes previous entry)
    - distributed_ledger_optional (for extra immutability)

immutability_enforcement:
  write_once_append_only:
    description: "Audit logs can only be appended, never modified or deleted"
    enforcement: "database_level_constraints + filesystem_level_immutability"
  
  cryptographic_hash_chain:
    description: "Each log entry includes hash of previous entry, creating verifiable chain"
    algorithm: "SHA-256"
    verification: "vision_guardian_can_verify_chain_integrity"
  
  tamper_detection:
    - hash_chain_breaks_if_any_entry_modified
    - vision_guardian_alerts_on_tamper_detection
    - tamper_detection_triggers_constitutional_crisis

integrity_verification_jobs:
  schedule_minutes: 10
  executor: "vision_guardian"
  actions:
    - "verify hash chain head"
    - "verify append-only storage checksums"
    - "cross-check audit_entry schema (contracts/data_contracts.yml#audit_entry_schema)"
  escalation_on_failure: "constitutional_crisis"

key_isolation:
  signing_keys:
    scope: "SYSTEM_AUDIT only"
    rotation_days: 60
    storage: "security/secrets_management_policy.yml"
    usage: "hash_chain_signatures"

what_gets_audited:
  component: "component_audit_logging_requirements.yml"
  
  summary:
    - every_agent_action
    - every_approval_request_and_decision
    - every_escalation
    - every_data_access (read/write/delete)
    - every_external_integration_call
    - every_ai_api_call
    - every_governance_decision
    - every_agent_creation_deployment_suspension_reactivation
    - every_configuration_change
    - every_precedent_seed_emission

audit_log_storage:
  primary_storage:
    type: "postgresql_with_append_only_tables"
    retention: "permanent"
    backup: "continuous_wal_archiving"
    replication: "synchronous_to_3_replicas"
  
  archive_storage:
    type: "s3_glacier_deep_archive"
    frequency: "monthly_snapshots"
    retention: "permanent"
    immutability: "s3_object_lock_enabled"
  
  access_control:
    - vision_guardian: "read_all"
    - systems_architect: "read_performance_metrics"
    - genesis: "read_agent_specific_audits"
    - platform_governor: "read_all"
    - agents: "no_access"
    - system_audit: "write_only"

audit_log_querying:
  query_interface:
    method: "query_audit_logs"
    authorization: "vision_guardian | platform_governor | systems_architect"
    inputs:
      - query_filters (agent_id, time_range, event_type, etc)
      - page_size
      - page_number
    outputs:
      - matching_audit_entries
      - total_count
      - query_execution_metadata
  
  common_queries:
    - all_actions_by_agent_X_in_last_24_hours
    - all_approvals_denied_by_governor
    - all_data_access_to_customer_Y
    - all_constitutional_violations
    - all_precedent_seeds_emitted

integration_with_components:
  ai_explorer:
    relationship: "AI Explorer calls SYSTEM_AUDIT to log every AI interaction"
    logged_data: "prompt, response, token usage, cost, agent_id, customer_id"
  
  outside_world_connector:
    relationship: "Outside World Connector calls SYSTEM_AUDIT to log every external interaction"
    logged_data: "integration_id, operation, parameters, response, agent_id, customer_id"
  
  governor_approval_workflow:
    relationship: "Governor workflow calls SYSTEM_AUDIT to log every approval decision"
    logged_data: "approval_request, decision, rationale, governor_id, timestamp"
  
  genesis_certification:
    relationship: "Genesis calls SYSTEM_AUDIT to log every certification decision"
    logged_data: "agent_id, certification_checks, decision, gaps_identified"
  
  health_check_protocol:
    relationship: "Health checker calls SYSTEM_AUDIT to log every health check and suspension"
    logged_data: "agent_id, check_type, status, suspension_trigger"

performance_requirements:
  write_throughput: "10000_log_entries_per_second_minimum"
  write_latency: "p99_latency_less_than_10ms"
  storage_growth: "estimated_1TB_per_month"
  query_performance: "p95_query_response_less_than_1_second"

monitoring:
  metrics_tracked:
    - log_entries_written_per_second
    - write_latency (p50, p95, p99)
    - storage_utilization
    - hash_chain_integrity_checks
    - query_performance
    - replication_lag
  
  alerts:
    - write_latency_exceeds_threshold
    - hash_chain_integrity_failure
    - storage_capacity_80_percent_full
    - replication_lag_exceeds_5_seconds
    - unauthorized_access_attempt

disaster_recovery:
  backup_strategy:
    - continuous_wal_archiving_to_s3
    - daily_full_backups
    - monthly_snapshots_to_glacier
  
  recovery_procedures:
    catastrophic_failure:
      step_1: "restore_from_latest_wal_archive"
      step_2: "verify_hash_chain_integrity"
      step_3: "replay_any_missing_entries_from_replicas"
      step_4: "vision_guardian_validates_recovery"
    
    data_corruption:
      step_1: "identify_corrupted_range_via_hash_chain"
      step_2: "restore_corrupted_range_from_backup"
      step_3: "verify_hash_chain_integrity"
      step_4: "log_recovery_incident"

trial_mode_behavior:
  trial_support_only_mode:
    behavior: "SYSTEM_AUDIT functions identically in trial mode"
    rationale: "Audit logging is required regardless of mode"
    note: "Trial mode agents generate less audit data, but logging mechanism is unchanged"

integration_with_governance:
  vision_guardian_responsibilities:
    - monitor_system_audit_for_deviations
    - verify_hash_chain_integrity_weekly
    - audit_the_auditor (review system_audit behavior)
    - respond_to_constitutional_crisis_if_system_audit_compromised
  
  systems_architect_responsibilities:
    - ensure_system_audit_availability
    - monitor_performance_and_storage
    - plan_capacity_for_audit_growth
    - optimize_query_performance
  
  platform_governor_responsibilities:
    - access_audit_logs_for_compliance_reviews
    - investigate_incidents_via_audit_trail
    - approve_audit_log_access_for_external_auditors

design_principles:
  - system_audit_has_one_purpose_only
  - governance_exemption_is_minimal_and_necessary
  - immutability_is_cryptographically_enforced
  - vision_guardian_monitors_the_monitor
  - audit_logs_are_æ°¸ä¹…_retained_æ°¸ä¹…_means_forever
  - performance_must_not_degrade_governance

cross_references:
  - component_audit_logging_requirements.yml (audit scope and structure)
  - foundation_constitution_engine.yaml (constitutional authority)
  - component_ai_explorer.yml (logs AI interactions)
  - component_outside_world_connector.yml (logs external interactions)
  - component_governor_approval_workflow.yml (logs approvals)
  - component_health_check_protocol.yml (logs health checks)

# =============================================================================
# ITERATION 2: CUSTOMER-FACING AUDIT LOG QUERY INTERFACE
# =============================================================================
audit_log_query_interface:
  
  description: "Customer-facing UI for viewing audit logs (transparency, debugging, compliance)"
  
  rationale:
    - transparency: "Customers see what their agents are doing (constitutional requirement)"
    - debugging: "Customers troubleshoot errors using correlation_id"
    - compliance: "Customers export audit logs for their own compliance needs"
    - trust: "Visible audit trail builds customer confidence"
  
  access_control:
    authorization: "Customer can ONLY view their own audit logs (never other customers)"
    authentication: "JWT token with customer_id"
    scope_filtering: "All queries auto-filtered by customer_id (SQL WHERE customer_id = X)"
  
  ui_location:
    customer_portal: "Settings â†’ Activity Log (or Dashboard â†’ Audit Trail)"
    mobile_app: "Menu â†’ Activity Log (limited view, last 50 events)"
  
  query_api:
    
    list_audit_logs:
      method: "GET"
      path: "/v1/audit/logs"
      authentication: "JWT token (customer_id extracted)"
      
      query_parameters:
        customer_id: "uuid (auto-extracted from JWT, not user-provided)"
        start_date: "ISO 8601 (default: 30 days ago)"
        end_date: "ISO 8601 (default: now)"
        event_type: "string (optional filter: APPROVAL_REQUEST, AGENT_ACTION, ERROR, etc.)"
        agent_id: "uuid (optional filter: show logs for specific agent)"
        correlation_id: "string (optional: search by correlation_id for error debugging)"
        severity: "enum (optional: info, warning, error, critical)"
        limit: "integer (default: 100, max: 1000 per page)"
        offset: "integer (pagination)"
      
      response:
        total_count: "integer (total logs matching filters)"
        logs: "array[audit_log_entry]"
        pagination:
          current_page: "integer"
          total_pages: "integer"
          next_offset: "integer (for next page)"
      
      example_response: |
        {
          "total_count": 1247,
          "logs": [
            {
              "log_id": "uuid",
              "timestamp": "2026-01-07T14:32:15Z",
              "event_type": "APPROVAL_REQUEST",
              "agent_id": "uuid",
              "agent_name": "Healthcare Content Writer",
              "action_summary": "Publish article 'Metformin Dosage Guide' to WordPress",
              "decision": "approved",
              "decided_by": "customer",
              "correlation_id": "CORR-550e8400",
              "severity": "info",
              "metadata": {
                "deliverable_id": "uuid",
                "word_count": 800,
                "quality_score": 4.8
              }
            },
            {
              "log_id": "uuid",
              "timestamp": "2026-01-07T14:28:42Z",
              "event_type": "ERROR",
              "agent_id": "uuid",
              "agent_name": "Healthcare Content Writer",
              "error_message": "WordPress API connection timeout",
              "correlation_id": "CORR-7a9f2b11",
              "severity": "error",
              "retry_count": 3,
              "resolved": false
            }
          ],
          "pagination": {
            "current_page": 1,
            "total_pages": 13,
            "next_offset": 100
          }
        }
    
    search_by_correlation_id:
      method: "GET"
      path: "/v1/audit/logs/search"
      authentication: "JWT token"
      
      query_parameters:
        correlation_id: "string (required, e.g., CORR-550e8400)"
      
      response:
        logs: "array[audit_log_entry] (all logs with same correlation_id)"
        trace: "object (reconstructed timeline of related events)"
      
      use_case: "Customer reports error, support provides correlation_id, customer searches logs"
  
  ui_components:
    
    log_viewer_table:
      columns:
        - timestamp: "Date/time (local timezone)"
        - event_type: "Icon + label (e.g., âœ… Approved, âŒ Error, ðŸ“¤ Action)"
        - agent: "Agent name + avatar"
        - action: "Summary (80 chars max, expandable)"
        - status: "Badge (Success, Failed, Pending)"
        - correlation_id: "Monospace text, copyable"
      
      row_expansion:
        trigger: "Click row to expand"
        details_shown:
          - full_metadata: "JSON tree view (collapsible)"
          - related_logs: "Other logs with same correlation_id (linked)"
          - actions: "Copy correlation_id, Download log entry, Report issue"
      
      filters_sidebar:
        date_range: "Presets (Today, Last 7 days, Last 30 days, Custom)"
        event_type: "Multi-select (Approvals, Errors, Actions, Settings Changes)"
        agent: "Dropdown (all customer's agents)"
        severity: "Multi-select (Info, Warning, Error, Critical)"
        search: "Text input (full-text search in action_summary, error_message)"
      
      sort_options:
        - timestamp_desc: "Newest first (default)"
        - timestamp_asc: "Oldest first"
        - severity_desc: "Critical errors first"
    
    correlation_id_search:
      location: "Prominent search bar at top of log viewer"
      placeholder: "Search by correlation ID (e.g., CORR-550e8400)"
      behavior: "Instant search (as user types, suggest matching logs)"
      result_display: "Timeline view showing all related events in chronological order"
    
    empty_state:
      scenario: "No logs match filters"
      message: "No activity found for selected filters"
      cta: "Clear filters or adjust date range"
  
  export_functionality:
    
    csv_export:
      trigger: "Click 'Export to CSV' button"
      format: "CSV file with columns: timestamp, event_type, agent_name, action, status, correlation_id"
      filename: "waooaw_audit_logs_{customer_id}_{start_date}_{end_date}.csv"
      max_rows: "10,000 per export (pagination for larger datasets)"
      
      use_case: "Customer analyzes logs in Excel, imports into compliance tools"
    
    pdf_export:
      trigger: "Click 'Download PDF Report' button"
      format: "PDF report with WAOOAW branding, table of logs, summary stats"
      sections:
        - cover_page: "Customer name, date range, total events"
        - summary_stats: "Event type breakdown, error count, approval rate"
        - detailed_logs: "Table of all logs (formatted for readability)"
        - footer: "Page numbers, generated timestamp, correlation_ids"
      filename: "WAOOAW_Audit_Report_{customer_id}_{date}.pdf"
      
      use_case: "Customer provides audit trail to auditors, regulators, management"
    
    api_export:
      method: "GET"
      path: "/v1/audit/logs/export"
      authentication: "JWT token"
      
      query_parameters: "Same as list_audit_logs (start_date, end_date, filters)"
      response_format: "application/json or text/csv (Accept header)"
      streaming: "true (for large datasets, stream response)"
  
  real_time_updates:
    
    websocket_connection:
      endpoint: "wss://api.waooaw.com/v1/audit/logs/stream"
      authentication: "JWT token in connection params"
      
      message_format: |
        {
          "event": "new_log",
          "log": {
            "log_id": "uuid",
            "timestamp": "ISO 8601",
            "event_type": "APPROVAL_REQUEST",
            ...
          }
        }
      
      use_case: "Customer watches live activity feed (agent actions stream in real-time)"
    
    polling_alternative:
      method: "GET"
      path: "/v1/audit/logs/recent"
      polling_interval: "10 seconds"
      response: "Last 10 new logs since last poll"
      
      use_case: "Fallback if WebSocket unsupported"
  
  privacy_redaction:
    
    sensitive_fields_redacted:
      - api_keys: "Show as 'sk_...****' (last 4 chars only)"
      - passwords: "Never logged (design principle)"
      - customer_pii: "Customer's own data NOT redacted (they can see their own PII)"
      - other_customer_data: "Fully redacted if somehow leaked (should never happen)"
    
    error_messages:
      sanitization: "Remove sensitive paths (e.g., /home/user/secrets.json â†’ [REDACTED_PATH])"
      rationale: "Prevent exposure of internal system details"
  
  performance_optimization:
    
    database_indexes:
      - customer_id_timestamp: "INDEX ON audit_logs (customer_id, timestamp DESC)"
      - correlation_id: "INDEX ON audit_logs (correlation_id)"
      - event_type: "INDEX ON audit_logs (customer_id, event_type, timestamp)"
    
    query_limits:
      max_date_range: "90 days per query (prevent full-table scans)"
      max_rows_per_page: "1000 (pagination required for larger datasets)"
      timeout: "30 seconds (abort slow queries)"
    
    caching:
      cache_layer: "Redis (5-minute TTL for recent logs)"
      cache_key: "audit_logs:{customer_id}:{filters_hash}"
      invalidation: "On new log insertion for customer"
  
  security_measures:
    
    authorization_enforcement:
      sql_injection_prevention: "Parameterized queries only (no string concatenation)"
      customer_isolation: "All queries include WHERE customer_id = ? (from JWT)"
      rate_limiting: "100 queries per hour per customer (prevent abuse)"
    
    audit_of_audit_access:
      log_event: "AUDIT_LOG_VIEWED"
      metadata:
        - customer_id: "uuid"
        - filters_applied: "object (date_range, event_type, etc.)"
        - rows_returned: "integer"
        - query_duration_ms: "integer"
      
      rationale: "Track who accesses audit logs (meta-audit trail)"
  
  compliance_features:
    
    tamper_evidence:
      display: "Show hash_chain_value for each log entry (collapsed by default)"
      verification: "Customer can verify hash chain integrity (advanced feature)"
      
      verification_ui:
        location: "Advanced â†’ Verify Audit Trail"
        process: "Customer selects date range â†’ system verifies hash chain â†’ shows result (âœ… Verified / âŒ Tampered)"
    
    retention_disclosure:
      display: "Footer message: 'Audit logs retained for 7 years per compliance requirements'"
      link: "Privacy Policy (GDPR compliance details)"
  
  mobile_app_considerations:
    
    limited_view:
      display: "Last 50 events (performance optimization)"
      filters: "Date range, event type only (simplified UI)"
      export: "Not available on mobile (redirect to web portal)"
    
    push_notification_integration:
      scenario: "Customer receives error notification â†’ taps â†’ opens audit log with correlation_id pre-filled"
      deep_link: "waooaw://audit/logs?correlation_id=CORR-550e8400"
  
  analytics_tracking:
    
    usage_metrics:
      - audit_log_views: "Counter (how many customers use this feature)"
      - correlation_id_searches: "Counter (debugging usage)"
      - exports_generated: "Counter (CSV vs PDF)"
      - average_date_range: "Histogram (7 days, 30 days, custom)"
    
    feature_adoption:
      target: ">30% of customers view audit logs monthly"
      rationale: "High transparency, builds trust"

# =============================================================================
# CHANGE LOG
# =============================================================================
change_log:
  - version: "1.1"
    date: "2026-01-07"
    changes:
      - "ITERATION 2: Added audit_log_query_interface section"
      - "Customer-facing log viewer UI (table, filters, search)"
      - "Correlation ID search for error debugging"
      - "CSV/PDF export for compliance reporting"
      - "Real-time updates via WebSocket"
      - "Privacy redaction, performance optimization, security measures"
    implemented: false
    approver: "pending"
  
  - version: "1.0"
    date: "2026-01-05"
    changes:
      - "Initial component creation"
      - "SYSTEM_AUDIT privileged account definition"
      - "Governance exemption rationale"
      - "Hash-chained immutability"
      - "Vision Guardian oversight"
    implemented: false
    approver: "pending"
