# Component: OAuth Credential Validation Flow
# Version: 1.0
# Owner: Systems Architect
# Purpose: Document OAuth integration flows for CP onboarding + setup wizard
# Resolves: GAP-CP-02 (CP Onboarding OAuth credential validation)

component:
  id: "component_oauth_credential_validation_flow"
  name: "OAuth Credential Validation Flow"
  version: "1.0"
  created: "2026-01-09"
  owner: "Systems Architect Agent"
  constitutional_alignment: "L0 Deny-by-Default + Data Minimization + Audit Trail"

metadata:
  purpose: "Secure OAuth integration for customer external services (WordPress, Mailchimp, CRM)"
  scope: "CP Onboarding (S2.2 step 1), CP Setup Wizard (S4.1 step 2)"
  services_impacted:
    - "Outside World Connector (Port 8009) - OAuth client implementation"
    - "Admin Gateway (Port 8006) - OAuth callback handler"
    - "Audit Service (Port 8010) - Credential access logging"
    - "Policy Service (Port 8013) - Permission validation"
  
  cross_references:
    - "component_outside_world_connector.yml"
    - "component_agent_setup_wizard.yml"
    - "security/secrets_management_policy.yml"

# =============================================================================
# SUPPORTED INTEGRATIONS (6 Services)
# =============================================================================
supported_integrations:
  
  wordpress:
    oauth_version: "OAuth 2.0"
    provider: "WordPress.com OR self-hosted with OAuth plugin"
    scopes_requested:
      - "read:posts"  # Read existing posts
      - "write:posts"  # Create/update posts
      - "manage:media"  # Upload images
    
    test_connection_actions:
      - action: "Fetch site info"
        api: "GET https://public-api.wordpress.com/rest/v1.1/sites/{site_id}"
        validation: "HTTP 200, site_name present"
      
      - action: "List posts (read-only test)"
        api: "GET https://public-api.wordpress.com/rest/v1.1/sites/{site_id}/posts"
        validation: "HTTP 200, posts array returned"
    
    no_writes_during_test: true
    credential_storage: "Google Secret Manager (per-engagement isolation)"
  
  mailchimp:
    oauth_version: "OAuth 2.0"
    provider: "Mailchimp"
    scopes_requested:
      - "audience:read"  # Read lists
      - "campaign:write"  # Create campaigns (drafts only in trial)
    
    test_connection_actions:
      - action: "Fetch account info"
        api: "GET https://<dc>.api.mailchimp.com/3.0/"
        validation: "HTTP 200, account_name present"
      
      - action: "List audiences"
        api: "GET https://<dc>.api.mailchimp.com/3.0/lists"
        validation: "HTTP 200, lists array (at least 1 list)"
    
    trial_mode_restrictions:
      - "Create campaign drafts only (no sending)"
      - "Test list: waooaw_test@example.com (no real subscribers)"
    
    credential_storage: "Google Secret Manager"
  
  salesforce:
    oauth_version: "OAuth 2.0"
    provider: "Salesforce"
    scopes_requested:
      - "api"  # Access Salesforce APIs
      - "refresh_token"  # Long-lived access
    
    test_connection_actions:
      - action: "Query user info"
        api: "GET https://{instance}.salesforce.com/services/oauth2/userinfo"
        validation: "HTTP 200, user_id present"
      
      - action: "Query test object (read-only)"
        api: "GET https://{instance}.salesforce.com/services/data/v57.0/query?q=SELECT+Id+FROM+Account+LIMIT+1"
        validation: "HTTP 200, records array"
    
    no_writes_during_test: true
    credential_storage: "Google Secret Manager"
  
  hubspot:
    oauth_version: "OAuth 2.0"
    provider: "HubSpot"
    scopes_requested:
      - "contacts"  # Read/write contacts
      - "content"  # Read/write blog posts
    
    test_connection_actions:
      - action: "Fetch account info"
        api: "GET https://api.hubapi.com/account-info/v3/details"
        validation: "HTTP 200, portalId present"
    
    credential_storage: "Google Secret Manager"
  
  google_workspace:
    oauth_version: "OAuth 2.0"
    provider: "Google"
    scopes_requested:
      - "https://www.googleapis.com/auth/drive.file"  # Google Drive (specific files only)
      - "https://www.googleapis.com/auth/gmail.send"  # Send emails
    
    test_connection_actions:
      - action: "Fetch user profile"
        api: "GET https://www.googleapis.com/oauth2/v2/userinfo"
        validation: "HTTP 200, email present"
    
    credential_storage: "Google Secret Manager"
  
  stripe:
    oauth_version: "OAuth 2.0"
    provider: "Stripe Connect"
    scopes_requested:
      - "read_only"  # Read transactions (for agent reporting)
    
    test_connection_actions:
      - action: "Fetch account"
        api: "GET https://api.stripe.com/v1/account"
        validation: "HTTP 200, business_profile present"
    
    trial_mode: "Stripe test mode (sk_test_*)"
    production_mode: "Stripe live mode (sk_live_*)"
    credential_storage: "Google Secret Manager"

# =============================================================================
# OAUTH FLOW (5 Steps - Standard OAuth 2.0)
# =============================================================================
oauth_flow:
  
  step_1_initiate_oauth:
    trigger: "Customer clicks 'Connect WordPress' in CP Onboarding (S2.2) OR Setup Wizard (S4.1)"
    
    ui_action:
      - "Customer clicks integration card (e.g., WordPress icon)"
      - "Modal opens: 'Connect your WordPress site'"
      - "Button: 'Authorize WAOOAW'"
    
    backend_action:
      api: "POST /v1/integrations/oauth/initiate"
      service: "Admin Gateway (Port 8006)"
      payload:
        customer_id: "{customer_id}"
        integration_type: "wordpress"
        agent_id: "{agent_id}"  # Agent that will use this integration
        redirect_uri: "https://cp.waooaw.com/oauth/callback"
      
      response:
        authorization_url: "https://public-api.wordpress.com/oauth2/authorize?client_id={client_id}&redirect_uri={redirect_uri}&response_type=code&scope=read:posts+write:posts"
        state_token: "{random_32_char_string}"  # CSRF protection
    
    frontend_action:
      - "Redirect customer to authorization_url"
      - "Customer sees WordPress login page"
      - "Customer authorizes WAOOAW app"
  
  step_2_oauth_callback:
    trigger: "WordPress redirects customer back to WAOOAW with authorization code"
    
    request:
      url: "https://cp.waooaw.com/oauth/callback?code={auth_code}&state={state_token}"
      method: "GET"
    
    backend_action:
      api: "POST /v1/integrations/oauth/callback"
      service: "Admin Gateway (Port 8006) → Outside World Connector (Port 8009)"
      payload:
        code: "{auth_code}"
        state: "{state_token}"
        integration_type: "wordpress"
      
      validation:
        - "Verify state_token matches (CSRF protection)"
        - "Exchange auth_code for access_token"
      
      token_exchange:
        api: "POST https://public-api.wordpress.com/oauth2/token"
        payload:
          client_id: "{waooaw_client_id}"
          client_secret: "{waooaw_client_secret}"
          code: "{auth_code}"
          redirect_uri: "https://cp.waooaw.com/oauth/callback"
          grant_type: "authorization_code"
        
        response:
          access_token: "{long_lived_access_token}"
          refresh_token: "{refresh_token}"  # For token renewal
          expires_in: 3600  # 1 hour
          token_type: "Bearer"
  
  step_3_store_credentials:
    trigger: "Access token received from OAuth provider"
    
    backend_action:
      service: "Outside World Connector (Port 8009)"
      
      credential_encryption:
        - "Encrypt access_token + refresh_token using Google Cloud KMS"
        - "Store in Google Secret Manager with naming convention: integrations/{customer_id}/{agent_id}/{integration_type}"
      
      database_record:
        table: "integrations"
        columns:
          customer_id: "{customer_id}"
          agent_id: "{agent_id}"
          integration_type: "wordpress"
          secret_path: "integrations/{customer_id}/{agent_id}/wordpress"
          scopes: ["read:posts", "write:posts"]
          token_expires_at: "2026-01-09T11:30:00Z"
          created_at: "2026-01-09T10:30:00Z"
          status: "pending_validation"  # Not yet tested
      
      audit_log:
        event: "integration.credentials_stored"
        payload:
          customer_id: "{customer_id}"
          agent_id: "{agent_id}"
          integration_type: "wordpress"
          scopes: ["read:posts", "write:posts"]
          stored_in: "google_secret_manager"
  
  step_4_test_connection:
    trigger: "Credentials stored, now validate they work"
    
    backend_action:
      service: "Outside World Connector (Port 8009)"
      
      test_sequence:
        test_1_fetch_site_info:
          api: "GET https://public-api.wordpress.com/rest/v1.1/sites/{site_id}"
          headers:
            Authorization: "Bearer {access_token}"
          expected: "HTTP 200, site_name present"
          on_failure: "Mark integration status: invalid_credentials"
        
        test_2_list_posts_read_only:
          api: "GET https://public-api.wordpress.com/rest/v1.1/sites/{site_id}/posts?number=1"
          headers:
            Authorization: "Bearer {access_token}"
          expected: "HTTP 200, posts array (even if empty)"
          on_failure: "Mark integration status: insufficient_permissions"
        
        no_write_tests: true  # NEVER write during validation (constitutional deny-by-default)
      
      update_database:
        table: "integrations"
        set:
          status: "validated"  # OR "invalid_credentials" OR "insufficient_permissions"
          validated_at: "2026-01-09T10:32:00Z"
          site_info: "{site_name: 'Customer Blog', url: 'customer.wordpress.com'}"
      
      audit_log:
        event: "integration.validated"
        payload:
          integration_id: "{integration_id}"
          validation_result: "success"
          tests_run: ["fetch_site_info", "list_posts"]
  
  step_5_notify_customer:
    trigger: "Test connection completed"
    
    frontend_action:
      on_success:
        - "Close OAuth modal"
        - "Show success message: '✓ WordPress connected (customer.wordpress.com)'"
        - "Integration card shows 'Connected' badge"
        - "Customer can proceed to next onboarding/setup step"
      
      on_failure:
        - "Show error message: 'Connection failed: {reason}'"
        - "Button: 'Try Again' (re-initiate OAuth)"
        - "Link: 'Need help? Contact support'"
    
    mobile_push_notification:
      condition: "Customer not actively using CP (session idle >5 min)"
      message: "WordPress successfully connected to your Healthcare Writer"

# =============================================================================
# SECURITY CONTROLS (Constitutional Compliance)
# =============================================================================
security_controls:
  
  deny_by_default:
    enforcement: "Integration disabled by default until explicitly authorized by customer"
    validation: "Policy Service (Port 8013) blocks agent from calling integration APIs without customer OAuth approval"
  
  data_minimization:
    principle: "Request minimum OAuth scopes needed for agent job"
    example: "Healthcare Writer needs read:posts + write:posts (NOT delete:posts)"
    validation: "Genesis reviews scope requests during job certification"
  
  credential_isolation:
    principle: "Each customer's credentials isolated (no cross-customer access)"
    implementation: "Google Secret Manager paths: integrations/{customer_id}/{agent_id}/{integration_type}"
    validation: "IAM policies enforce per-customer secrets access"
  
  audit_trail:
    requirement: "Log every credential access (who, when, what integration)"
    implementation: "Audit Service (Port 8010) logs integration.credentials_accessed event"
    retention: "7 years (compliance requirement)"
  
  token_rotation:
    requirement: "Refresh OAuth tokens before expiry"
    implementation:
      - "Background job runs hourly: check integrations.token_expires_at"
      - "If expiring <24 hours, use refresh_token to get new access_token"
      - "Update Google Secret Manager + database"
    fallback: "If refresh fails, notify customer to re-authorize"
  
  revocation_support:
    customer_action: "Customer can disconnect integration anytime (CP Settings)"
    backend_action:
      - "DELETE /v1/integrations/{integration_id}"
      - "Revoke OAuth token at provider (if supported)"
      - "Delete from Google Secret Manager"
      - "Update database: status = 'revoked'"

# =============================================================================
# TRIAL MODE RESTRICTIONS
# =============================================================================
trial_mode_restrictions:
  
  sandbox_routing:
    wordpress:
      production: "customer.wordpress.com (real site)"
      trial: "staging.waooaw.com/wordpress-mock (local mock)"
      implementation: "Outside World Connector checks subscription.trial_mode flag, routes to mock"
    
    mailchimp:
      production: "Real Mailchimp account"
      trial: "Mock Mailchimp API (returns success, no emails sent)"
    
    stripe:
      production: "Stripe live mode (sk_live_*)"
      trial: "Stripe test mode (sk_test_*, card 4242 4242 4242 4242)"
  
  read_only_enforcement:
    rule: "During trial, agent can READ from integrations but CANNOT WRITE"
    exceptions: "WordPress drafts (write allowed), Mailchimp campaign drafts (write allowed)"
    enforcement: "Policy Service PDP rejects write operations in trial mode"
  
  go_live_credential_re_validation:
    trigger: "Customer clicks 'Go Live' (S5.1)"
    action:
      - "Re-test all integrations with production endpoints"
      - "If any fail, block go-live, notify customer"
      - "Customer must re-authorize if credentials expired"

# =============================================================================
# ERROR HANDLING
# =============================================================================
error_scenarios:
  
  error_1_oauth_denied:
    scenario: "Customer clicks 'Deny' on WordPress authorization page"
    detection: "OAuth callback receives error=access_denied"
    resolution:
      - "Show customer: 'Authorization cancelled. You can try again anytime.'"
      - "Integration status: not_connected"
      - "No audit log entry (customer choice, not a failure)"
  
  error_2_invalid_scopes:
    scenario: "WordPress denies write:posts scope (customer has read-only account)"
    detection: "Test connection fails with HTTP 403 on write operation"
    resolution:
      - "Mark integration: insufficient_permissions"
      - "Show customer: 'WordPress account lacks permissions. Need Editor or Admin role.'"
      - "Offer: 'Contact your WordPress admin' OR 'Skip this integration'"
  
  error_3_token_expired:
    scenario: "Access token expires (1 hour), refresh token used"
    detection: "API call returns HTTP 401 Unauthorized"
    resolution:
      - "Automatically refresh token using refresh_token"
      - "Retry API call with new access_token"
      - "If refresh fails: notify customer to re-authorize"
  
  error_4_integration_revoked:
    scenario: "Customer revokes WAOOAW app in WordPress dashboard"
    detection: "API call returns HTTP 401 with error=invalid_token"
    resolution:
      - "Mark integration: revoked_by_customer"
      - "Pause agent execution (cannot proceed without credentials)"
      - "Notify customer: 'WordPress connection lost. Please reconnect.'"
  
  error_5_test_connection_timeout:
    scenario: "WordPress API unresponsive (>10 seconds)"
    detection: "Timeout exception in Outside World Connector"
    resolution:
      - "Retry 3x with exponential backoff (5s, 10s, 20s)"
      - "If all fail: mark integration: connection_timeout"
      - "Show customer: 'WordPress unreachable. Try again in a few minutes.'"

# =============================================================================
# MONITORING & ALERTING
# =============================================================================
monitoring:
  
  cloud_monitoring_metrics:
    - metric: "oauth_flow_completions"
      type: "counter"
      labels: ["integration_type", "status"]  # success, denied, timeout
    
    - metric: "oauth_flow_duration"
      type: "histogram"
      labels: ["integration_type"]
      alert_threshold: ">60 seconds p95 (slow OAuth)"
    
    - metric: "test_connection_failures"
      type: "counter"
      labels: ["integration_type", "failure_reason"]
      alert_threshold: ">10 failures/hour (provider outage)"
    
    - metric: "token_refresh_failures"
      type: "counter"
      labels: ["integration_type"]
      alert_threshold: ">5 failures/hour (credential issue)"
  
  pub_sub_events:
    - "integration.oauth_initiated"
    - "integration.credentials_stored"
    - "integration.validated"
    - "integration.validation_failed"
    - "integration.token_refreshed"
    - "integration.revoked"

# =============================================================================
# CONSTITUTIONAL VALIDATION
# =============================================================================
constitutional_compliance:
  
  l0_deny_by_default:
    enforcement: "Agent cannot access integration until customer explicitly authorizes OAuth"
    validation: "Policy Service blocks API calls without validated integration"
  
  data_minimization:
    enforcement: "Request minimum OAuth scopes (read:posts, NOT admin:all)"
    validation: "Genesis reviews scope requests during job certification"
  
  audit_trail:
    enforcement: "Log every credential access (integration.credentials_accessed event)"
    validation: "Audit Service appends to hash-chained audit_log.jsonl"
  
  customer_control:
    enforcement: "Customer can revoke integration anytime (no platform lock-in)"
    validation: "DELETE /v1/integrations API + OAuth token revocation"

# =============================================================================
# TESTING SCENARIOS
# =============================================================================
test_scenarios:
  
  scenario_1_happy_path:
    steps:
      - "Customer clicks 'Connect WordPress'"
      - "OAuth flow completes (customer authorizes)"
      - "Credentials stored in Google Secret Manager"
      - "Test connection succeeds (read posts)"
      - "Integration marked 'validated'"
      - "Customer sees '✓ WordPress connected'"
    expected_duration: "30-60 seconds"
  
  scenario_2_customer_denies:
    steps:
      - "Customer clicks 'Connect WordPress'"
      - "Customer clicks 'Deny' on WordPress auth page"
      - "OAuth callback receives error=access_denied"
      - "Show customer 'Authorization cancelled'"
      - "Integration status: not_connected"
    expected_duration: "10-20 seconds"
  
  scenario_3_token_expires:
    steps:
      - "Integration connected (1 hour ago)"
      - "Agent attempts WordPress API call"
      - "HTTP 401 Unauthorized (token expired)"
      - "Automatically refresh token"
      - "Retry API call with new token"
      - "Success (customer never knows token expired)"
    expected_duration: "2-5 seconds (automatic)"
